<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Énergie 2026 - Côté Parc</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { 
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb' }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(59, 130, 246, 0.15)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/countup.js@2.0.7/dist/countUp.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            /* Fond avec gradient subtil */
            background: radial-gradient(circle at top left, #f1f5f9, #e2e8f0);
        }
        @media (prefers-color-scheme: dark) {
            body { background: radial-gradient(circle at top left, #1e293b, #0f172a); }
        }

        /* Modern Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            border-color: rgba(255, 255, 255, 0.8);
        }

        @media (prefers-color-scheme: dark) {
            .glass-card {
                background: rgba(30, 41, 59, 0.4);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            }
            .glass-card:hover {
                background: rgba(30, 41, 59, 0.6);
                border-color: rgba(255, 255, 255, 0.15);
            }
        }

        /* Hide Scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Modern Filter Button */
        .filter-btn { 
            transition: all 0.2s ease; 
            position: relative;
            overflow: hidden;
        }
        .filter-btn::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: transparent; transition: background 0.2s;
        }
        .filter-btn.active { 
            background: #fff; color: #0f172a; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .filter-btn.active::after { background: #3b82f6; }

        @media (prefers-color-scheme: dark) {
            .filter-btn.active { background: #1e293b; color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        }

        /* Gauge Styling */
        .gauge-container { position: relative; width: 100%; height: 100px; display: flex; justify-content: center; align-items: flex-end; overflow: visible; }
        .gauge-arc {
            width: 180px; height: 90px;
            background: conic-gradient(from 180deg at 50% 100%, 
                #22c55e 0deg 45deg,   /* Good */
                #eab308 45deg 90deg,  /* Mid */
                #f97316 90deg 135deg, /* Warning */
                #ef4444 135deg 180deg /* Bad */
            );
            border-top-left-radius: 100px; border-top-right-radius: 100px;
            opacity: 0.9;
            mask-image: radial-gradient(circle at 50% 100%, transparent 60%, black 61%);
            -webkit-mask-image: radial-gradient(circle at 50% 100%, transparent 60%, black 61%);
        }
        .gauge-needle {
            width: 4px; height: 85px; background: #334155;
            position: absolute; bottom: 0; left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 4px; z-index: 10;
        }
        .gauge-center {
            width: 12px; height: 12px; background: #334155; border-radius: 50%;
            position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); z-index: 11;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        @media (prefers-color-scheme: dark) { 
            .gauge-needle, .gauge-center { background: #e2e8f0; } 
        }

        /* Chart Tooltip Customization */
        #chartjs-tooltip { opacity: 1; position: absolute; background: rgba(0, 0, 0, 0.7); color: white; border-radius: 3px; pointer-events: none; transform: translate(-50%, 0); transition: all .1s ease; }
    </style>
</head>
<body class="text-slate-600 dark:text-slate-400 antialiased flex flex-col min-h-screen selection:bg-indigo-500 selection:text-white pb-10">

    <!-- Background Orbs (Decorative) -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-400/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-emerald-400/20 rounded-full blur-[100px]"></div>
    </div>

    <!-- Header -->
    <header class="sticky top-4 z-50 px-4 md:px-8 mb-6">
        <div class="glass-card rounded-2xl px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4 max-w-7xl mx-auto border border-white/40 dark:border-white/10 shadow-lg shadow-black/5">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="bg-gradient-to-br from-indigo-500 to-blue-600 p-2.5 rounded-xl text-white shadow-lg shadow-indigo-500/30">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-base font-bold text-slate-900 dark:text-white tracking-tight">Résidence Côté Parc</h1>
                    <div class="flex items-center gap-2 text-xs font-medium">
                        <span class="text-slate-500 dark:text-slate-400">Projection 2026</span>
                        <span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-600"></span>
                        <span class="text-emerald-500 flex items-center gap-1">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                            </span>
                            MAJ <span id="last-updated-date">--/--</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex items-center gap-3 w-full md:w-auto overflow-x-auto hide-scrollbar pb-1 md:pb-0">
                <div class="flex bg-slate-100/50 dark:bg-slate-800/50 p-1 rounded-xl" id="yearFilters">
                    <!-- Buttons injected via JS -->
                </div>
                <button onclick="exportToCSV()" class="p-2.5 rounded-xl bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600 hover:text-indigo-500 transition-colors shadow-sm ml-auto md:ml-0" title="Export CSV">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </button>
                <!-- Mobile Select Fallback (Hidden on Desktop) -->
                <select id="yearFilterSelect" onchange="renderDashboard(this.value)" class="md:hidden sr-only"></select> 
            </div>
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto px-4 md:px-8 space-y-6 flex-grow">
        
        <!-- BENTO GRID LAYOUT -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6">
            
            <!-- Tuile 1 : Fiche Logement (Col-span 3) -->
            <div class="lg:col-span-3 glass-card rounded-3xl p-6 flex flex-col justify-between group">
                <div class="flex justify-between items-start mb-6">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg text-indigo-600 dark:text-indigo-400 group-hover:scale-110 transition-transform duration-300">
                        <i data-lucide="home" class="w-5 h-5"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 border border-slate-200 dark:border-slate-700 px-2 py-1 rounded-full">Infos</span>
                </div>
                <div class="space-y-4">
                    <div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-medium mb-1">Surface & Type</p>
                        <p class="text-xl font-bold text-slate-900 dark:text-white tracking-tight">42 m² <span class="text-sm text-slate-400 font-normal">/ T2</span></p>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Pos.</p>
                            <p class="text-sm font-semibold text-slate-700 dark:text-slate-200">RDC</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl">
                            <p class="text-[10px] text-slate-400 uppercase font-bold">Orient.</p>
                            <p class="text-sm font-semibold text-slate-700 dark:text-slate-200">N-Est</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tuile 2 : Performance DPE (Col-span 3) -->
            <div class="lg:col-span-3 glass-card rounded-3xl p-6 relative overflow-hidden flex flex-col justify-between">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 via-yellow-500 to-red-500"></div>
                
                <div class="w-full flex justify-between items-center z-10 mb-4">
                    <h3 class="text-sm font-bold text-slate-700 dark:text-slate-200" id="dpe-title">Performance</h3>
                    <div id="dpe-grade-badge" class="w-8 h-8 rounded-lg bg-slate-900 text-white flex items-center justify-center font-black shadow-lg transition-colors duration-300">-</div>
                </div>

                <div class="flex flex-col items-center justify-center w-full flex-grow">
                    <!-- Gauge -->
                    <div class="gauge-container scale-110 mb-6"> 
                        <div class="gauge-arc"></div>
                        <div class="gauge-needle" id="dpe-needle"></div>
                        <div class="gauge-center"></div>
                    </div>
                    
                    <!-- Value Bar -->
                    <div class="w-full bg-slate-100 dark:bg-slate-800/80 rounded-2xl p-3 flex items-center justify-between shadow-inner border border-slate-200/50 dark:border-slate-700/50">
                         <div class="flex items-center gap-2">
                            <div class="p-1.5 bg-white dark:bg-slate-700 rounded-lg text-slate-400 shadow-sm border border-slate-100 dark:border-slate-600">
                                <i data-lucide="activity" class="w-4 h-4"></i>
                            </div>
                            <span class="text-[10px] font-bold uppercase text-slate-400 leading-tight">Conso.<br>Moyenne</span>
                         </div>
                         <div class="text-right">
                            <span id="dpe-value" class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">--</span>
                            <span class="text-[10px] font-bold text-slate-500">kWh/m²</span>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Tuile 3 : Simulateur (Col-span 6) -->
            <div class="lg:col-span-6 glass-card rounded-3xl p-6 bg-gradient-to-br from-white to-emerald-50/50 dark:from-slate-800 dark:to-emerald-900/10 border-l-4 border-l-emerald-500 relative">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <i data-lucide="piggy-bank" class="w-5 h-5 text-emerald-500"></i>
                            <span id="gain-title">Gain Estimé</span>
                        </h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400" id="savings-subtitle">Comparatif vs Historique</p>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-1 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex">
                         <button onclick="updateThermostat(0)" class="thermostat-btn px-3 py-1.5 text-xs font-bold rounded-lg transition-all" data-val="0">Actuel</button>
                         <button onclick="updateThermostat(1)" class="thermostat-btn px-3 py-1.5 text-xs font-bold rounded-lg transition-all" data-val="1">-1°C</button>
                         <button onclick="updateThermostat(2)" class="thermostat-btn px-3 py-1.5 text-xs font-bold rounded-lg transition-all" data-val="2">-2°C</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 items-end">
                    <div class="col-span-2 md:col-span-1">
                        <p class="text-4xl md:text-5xl font-black text-emerald-600 dark:text-emerald-400 tracking-tighter" id="savings-value">...</p>
                        <p class="text-xs font-semibold text-emerald-600/60 dark:text-emerald-400/60 mt-1">Économie Potentielle</p>
                    </div>
                    
                    <!-- Details Sub-cards -->
                    <div class="bg-white/60 dark:bg-slate-900/60 rounded-xl p-3 border border-emerald-100 dark:border-emerald-900/30">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                            <span class="text-[10px] uppercase font-bold text-slate-400">Offre</span>
                        </div>
                        <div class="text-sm text-slate-700 dark:text-slate-200" id="gain-elec">...</div>
                    </div>
                    
                    <div class="bg-white/60 dark:bg-slate-900/60 rounded-xl p-3 border border-emerald-100 dark:border-emerald-900/30">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                            <span class="text-[10px] uppercase font-bold text-slate-400">Sobriété</span>
                        </div>
                        <div class="text-sm text-slate-700 dark:text-slate-200" id="gain-gaz">...</div>
                    </div>
                </div>
            </div>

            <!-- CHART SECTION (Col-span 8) -->
            <div class="lg:col-span-8 glass-card rounded-3xl p-6 flex flex-col min-h-[400px]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800 dark:text-slate-200">Consommation & Coûts</h3>
                    
                    <div class="flex gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Élec</p>
                            <p class="text-sm font-bold text-blue-600 dark:text-blue-400" id="kpi-elec">...</p>
                        </div>
                        <div class="text-right hidden sm:block">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Gaz</p>
                            <p class="text-sm font-bold text-orange-500 dark:text-orange-400" id="kpi-gaz">...</p>
                        </div>
                        <div class="text-right pl-4 border-l border-slate-200 dark:border-slate-700">
                            <p class="text-[10px] uppercase font-bold text-slate-400">Total</p>
                            <p class="text-lg font-black text-slate-900 dark:text-white" id="kpi-cost">...</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex-grow w-full relative">
                    <canvas id="energyChart"></canvas>
                </div>
            </div>

            <!-- ANALYSE DETAILS (Col-span 4) -->
            <div class="lg:col-span-4 glass-card rounded-3xl p-6 flex flex-col justify-center gap-6">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <div id="analysis-gaz-label" class="flex items-center gap-2 text-orange-600 dark:text-orange-400 font-bold text-sm">
                            <i data-lucide="flame" class="w-4 h-4"></i> Gaz
                        </div>
                        <span id="badge-gaz" class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-slate-100 text-slate-600">...</span>
                    </div>
                    <div class="h-3 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden relative">
                         <div id="gauge-gaz" class="h-full bg-gradient-to-r from-orange-300 to-orange-600 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                    <p id="analysis-gaz-text" class="text-xs text-slate-500 dark:text-slate-400 mt-2 font-medium">...</p>
                </div>

                <div class="w-full h-px bg-slate-100 dark:bg-slate-700/50"></div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <div id="analysis-elec-label" class="flex items-center gap-2 text-blue-600 dark:text-blue-400 font-bold text-sm">
                            <i data-lucide="zap" class="w-4 h-4"></i> Élec
                        </div>
                        <span id="badge-elec" class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-slate-100 text-slate-600">...</span>
                    </div>
                    <div class="h-3 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden relative">
                         <div id="gauge-elec" class="h-full bg-gradient-to-r from-blue-300 to-blue-600 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                    <p id="analysis-elec-text" class="text-xs text-slate-500 dark:text-slate-400 mt-2 font-medium">...</p>
                </div>
                
                <div class="mt-2 bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800/30">
                    <p class="text-xs text-indigo-800 dark:text-indigo-200 font-semibold flex gap-2">
                        <i data-lucide="info" class="w-4 h-4 shrink-0"></i>
                        Le chauffage représente ~65% de la facture. Chaque degré en moins = 7% d'économie.
                    </p>
                </div>
            </div>

            <!-- TABLE (Full Width) -->
            <div class="lg:col-span-12 glass-card rounded-3xl overflow-hidden">
                 <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700/50 bg-slate-50/30 dark:bg-slate-800/30 backdrop-blur-sm flex justify-between items-center">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Détail des factures</h3>
                    <div class="flex gap-2">
                         <span class="w-2 h-2 rounded-full bg-green-500"></span> <span class="text-[10px] text-slate-400">Réel</span>
                         <span class="w-2 h-2 rounded-full bg-slate-300 ml-2"></span> <span class="text-[10px] text-slate-400">Estimé</span>
                    </div>
                </div>
                <div id="records-container"></div>
            </div>
            
        </div>
    </main>

    <footer class="mt-8 py-8 text-center border-t border-slate-200/50 dark:border-slate-700/50 bg-white/30 dark:bg-slate-900/30 backdrop-blur-lg w-full">
        <p class="text-xs text-slate-500 font-medium">© 2026 | Données Personnelles | Côté Parc</p>
        <p class="text-[10px] text-slate-400 mt-1">Design Moderne &bull; Généré par IA</p>
    </footer>

    <!-- Logic Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // GLOBAL STATE
            let currentThermostatDrop = 0; 
            let currentYearFilter = 'all';

            // CONFIG & TARIFS
            const CONFIG = {
                surface: 42,
                benchmarks: {
                    gaz: { avg: 110 * 42, max: 150 * 42 },
                    elec: { avg: 1800, max: 3000 }
                },
                tariffs: {
                    engie: { elec: { kwh: 0.2276, sub_m: 13.00 }, gas: { kwh: 0.1082, sub_m: 21.00 } },
                    ohm: { elec: { kwh: 0.1794, sub_m: 16.79 }, gas: { kwh: 0.1340, sub_m: 10.95 } }
                }
            };

            // DATA 2023-2025
            const csvData = `Date_Facture;Période_Debut;Période_Fin;Type_Energie;Index_Debut;Index_Fin;Conso_kWh;Prix_Unitaire_HT;Montant_TTC;Type_Estime_Reel
03/12/2025;01/10/2025;30/11/2025;Gaz;3102;3143;462;0,04608;112,66;Réel
03/12/2025;03/10/2025;02/12/2025;Electricité;9379;9648;269;0,10281;88,67;Réel
03/10/2025;01/08/2025;30/09/2025;Gaz;3085;3102;194;0,04608;82,88;Réel
03/10/2025;03/08/2025;02/10/2025;Electricité;9161;9379;218;0,10281;70,57;Réel
03/08/2025;01/06/2025;31/07/2025;Gaz;3068;3085;192;0,04608;82,35;Réel
03/08/2025;03/06/2025;02/08/2025;Electricité;8924;9161;237;0,10281;74,64;Réel
03/06/2025;01/04/2025;31/05/2025;Gaz;3037;3068;346;0,04608;89,21;Réel
03/06/2025;03/04/2025;02/06/2025;Electricité;8688;8924;236;0,10281;71,77;Réel
03/04/2025;01/02/2025;31/03/2025;Gaz;2951;3037;962;0,04608;154,23;Réel
03/04/2025;03/02/2025;02/04/2025;Electricité;8421;8688;267;0,10281;94,87;Réel
03/02/2025;01/12/2024;31/01/2025;Gaz;2818;2951;1500;0,04608;205,07;Réel
03/02/2025;03/12/2024;02/02/2025;Electricité;8180;8421;241;0,10281;75,34;Réel
03/12/2024;26/09/2024;30/11/2024;Gaz;2737;2818;919;0,06548;141,72;Réel
03/12/2024;03/10/2024;02/12/2024;Electricité;7947;8180;233;0,12701;68,56;Réel
03/10/2024;01/08/2024;25/09/2024;Gaz;2717;2737;226;0,06548;71,70;Réel
03/10/2024;03/08/2024;02/10/2024;Electricité;7743;7947;204;0,12701;61,72;Réel
04/08/2024;01/06/2024;31/07/2024;Gaz;2689;2717;311;0,06548;83,37;Réel
04/08/2024;03/06/2024;02/08/2024;Electricité;7512;7743;231;0,12701;66,52;Réel
04/06/2024;01/04/2024;31/05/2024;Gaz;2625;2689;714;0,06548;112,25;Réel
04/06/2024;03/04/2024;02/06/2024;Electricité;7297;7512;215;0,12701;62,88;Réel
03/04/2024;01/02/2024;31/03/2024;Gaz;2534;2625;1010;0,06548;141,21;Estimé
03/04/2024;03/02/2024;02/04/2024;Electricité;7064;7297;233;0,12701;68,31;Réel
04/02/2024;30/11/2023;31/01/2024;Gaz;2397;2534;1542;0,06548;185,74;Réel
04/02/2024;03/12/2023;02/02/2024;Electricité;6816;7064;248;0,12701;64,95;Réel
03/12/2023;01/10/2023;29/11/2023;Gaz;2341;2397;625;0,06548;97,99;Réel
03/12/2023;03/10/2023;02/12/2023;Electricité;6574;6816;242;0,12701;64,56;Réel
04/10/2023;01/08/2023;30/09/2023;Gaz;2316;2341;283;0,06548;67,20;Réel
04/10/2023;03/08/2023;02/10/2023;Electricité;6342;6574;232;0,12701;62,63;Réel
04/08/2023;31/05/2023;31/07/2023;Gaz;2295;2316;235;0,06548;63,48;Estimé
04/08/2023;03/06/2023;02/08/2023;Electricité;6111;6342;231;0,12701;62,33;Réel
04/06/2023;01/04/2023;30/05/2023;Gaz;2223;2295;808;0,06548;112,33;Réel
04/06/2023;03/04/2023;02/06/2023;Electricité;5832;6111;279;0,12701;69,17;Réel
03/04/2023;01/02/2023;31/03/2023;Gaz;2071;2223;1706;0,06548;191,83;Réel
03/04/2023;03/02/2023;02/04/2023;Electricité;5524;5832;308;0,12701;70,96;Réel`;

            const tempNantesMap = { 1:6.0, 2:6.5, 3:9.0, 4:11.5, 5:15.0, 6:18.5, 7:20.5, 8:20.5, 9:17.5, 10:14.0, 11:9.5, 12:6.5 };

            let allData = [];
            let chartInstance = null;

            const parseFrFloat = (s) => parseFloat(s.replace(',', '.'));
            const parseFrDate = (s) => { const p = s.split('/'); return new Date(p[2], p[1]-1, p[0]); };

            function processMonthlyHistory(rows) {
                const monthlyData = [];
                rows.forEach(r => {
                    const c = r.split(';');
                    const d1 = parseFrDate(c[1]);
                    const d2 = parseFrDate(c[2]);
                    const type = c[3];
                    const conso = parseFrFloat(c[6]);
                    const cost = parseFrFloat(c[8]);
                    
                    if(d1.getFullYear() < 2023) return;

                    let startM = d1.getMonth();
                    let startY = d1.getFullYear();
                    let endM = d2.getMonth();
                    let endY = d2.getFullYear();
                    
                    let monthsDiff = (endY - startY) * 12 + (endM - startM) + 1;
                    if (d2.getDate() < 15) monthsDiff--; 
                    if (monthsDiff < 1) monthsDiff = 1;

                    const monthlyConso = conso / monthsDiff;
                    const monthlyCost = cost / monthsDiff;

                    for(let i=0; i<monthsDiff; i++) {
                        let currentM = new Date(startY, startM + i, 1);
                        let mIdx = currentM.getMonth();
                        
                        monthlyData.push({
                            date: currentM,
                            endDate: new Date(currentM.getFullYear(), currentM.getMonth() + 1, 0),
                            dateStr: currentM.toLocaleDateString('fr'),
                            rangeStr: currentM.toLocaleDateString('fr', {month: 'long', year: 'numeric'}),
                            year: currentM.getFullYear(),
                            type: type,
                            conso: monthlyConso,
                            cost: monthlyCost,
                            temp: tempNantesMap[mIdx + 1],
                            isProjection: false,
                            provider: currentM.getFullYear() >= 2026 ? 'Ohm' : 'Engie'
                        });
                    }
                });
                return monthlyData;
            }

            function generateProjection2026(historicalData) {
                const projections = [];
                const hasDec25 = historicalData.some(d => d.year === 2025 && d.date.getMonth() === 11);
                
                if (!hasDec25) {
                    const avgGazDec = 1500 / 2; 
                    const avgElecDec = 300 / 2;
                    
                    projections.push({
                        date: new Date(2025, 11, 1), endDate: new Date(2025, 11, 31),
                        dateStr: '01/12/2025', rangeStr: 'décembre 2025', year: 2025, type: 'Gaz', conso: avgGazDec,
                        cost: (avgGazDec * CONFIG.tariffs.engie.gas.kwh) + (CONFIG.tariffs.engie.gas.sub_m), 
                        temp: 6.5, isProjection: true, provider: 'Engie'
                    });
                    projections.push({
                        date: new Date(2025, 11, 1), endDate: new Date(2025, 11, 31),
                        dateStr: '01/12/2025', rangeStr: 'décembre 2025', year: 2025, type: 'Electricité', conso: avgElecDec,
                        cost: (avgElecDec * CONFIG.tariffs.engie.elec.kwh) + (CONFIG.tariffs.engie.elec.sub_m), 
                        temp: 6.5, isProjection: true, provider: 'Engie'
                    });
                }

                const heatingFactor = 1 - (currentThermostatDrop * 0.07);

                for (let m = 0; m < 12; m++) {
                    const year = 2026;
                    const dateObj = new Date(year, m, 1);
                    
                    const weightsGaz = [0.18, 0.16, 0.12, 0.08, 0.03, 0, 0, 0, 0.02, 0.07, 0.14, 0.20];
                    const annualGazEst = 3700;
                    
                    const baseECS = 0.02;
                    let weight = weightsGaz[m];
                    let monthlyGaz;

                    if (weight <= baseECS) {
                         monthlyGaz = annualGazEst * 0.02;
                    } else {
                         let heatingPart = (weight - baseECS) * annualGazEst * heatingFactor;
                         let ecsPart = baseECS * annualGazEst;
                         monthlyGaz = heatingPart + ecsPart;
                    }

                    const weightsElec = [0.11, 0.10, 0.09, 0.08, 0.07, 0.06, 0.06, 0.06, 0.07, 0.08, 0.10, 0.12];
                    const annualElecEst = 1600;
                    let monthlyElec = annualElecEst * weightsElec[m];

                    const temp = tempNantesMap[m + 1];

                    projections.push({
                        date: dateObj, endDate: new Date(year, m + 1, 0),
                        dateStr: dateObj.toLocaleDateString('fr'), rangeStr: dateObj.toLocaleDateString('fr', {month:'long', year:'numeric'}), 
                        year: 2026, type: 'Gaz', conso: monthlyGaz,
                        cost: (monthlyGaz * CONFIG.tariffs.ohm.gas.kwh) + (CONFIG.tariffs.ohm.gas.sub_m), 
                        temp: temp, isProjection: true, provider: 'Ohm'
                    });

                    projections.push({
                        date: dateObj, endDate: new Date(year, m + 1, 0),
                        dateStr: dateObj.toLocaleDateString('fr'), rangeStr: dateObj.toLocaleDateString('fr', {month:'long', year:'numeric'}), 
                        year: 2026, type: 'Electricité', conso: monthlyElec,
                        cost: (monthlyElec * CONFIG.tariffs.ohm.elec.kwh) + (CONFIG.tariffs.ohm.elec.sub_m), 
                        temp: temp, isProjection: true, provider: 'Ohm'
                    });
                }
                return projections;
            }

            function initData() {
                const rows = csvData.trim().split('\n').slice(1);
                let historyMonthly = processMonthlyHistory(rows);
                const proj = generateProjection2026(historyMonthly);
                allData = [...historyMonthly, ...proj].sort((a,b) => a.date - b.date);
                
                // Filters
                const years = [...new Set(allData.map(d=>d.year))].sort();
                const fContainer = document.getElementById('yearFilters');
                const mSelect = document.getElementById('yearFilterSelect');
                if(fContainer) {
                    fContainer.innerHTML = '';
                    mSelect.innerHTML = '';
                    
                    const mkBtn = (lbl, val) => {
                        const b = document.createElement('button');
                        b.innerText=lbl; b.dataset.year=val; 
                        b.className = `filter-btn px-4 py-1.5 rounded-lg text-xs font-semibold whitespace-nowrap ${val == currentYearFilter ? 'active' : 'text-slate-500 hover:text-slate-800 dark:hover:text-white'}`;
                        b.onclick=()=>renderDashboard(val);
                        fContainer.appendChild(b);
                    };
                    mkBtn('Tout', 'all');
                    years.forEach(y => mkBtn(y, y));

                    const optAll = document.createElement('option'); optAll.value='all'; optAll.text='Tout'; mSelect.appendChild(optAll);
                    years.forEach(y => {
                        const opt = document.createElement('option'); opt.value=y; opt.text=y; mSelect.appendChild(opt);
                    });
                }
                
                const realData = allData.filter(d => !d.isProjection);
                if(realData.length) {
                    const max = new Date(Math.max(...realData.map(e=>e.endDate)));
                    if (document.getElementById('last-updated-date'))
                        document.getElementById('last-updated-date').innerText = max.toLocaleDateString('fr-FR');
                }
            }

            window.exportToCSV = function() {
                const h = "Date;Période;Type;kWh;Euro;Temp;Statut\n";
                const r = allData.map(d => `${d.date.toLocaleDateString()};${d.rangeStr};${d.type};${d.conso.toFixed(0)};${d.cost.toFixed(2)};${d.temp.toFixed(1)};${d.isProjection?'Projection':'Réel'}`).join("\n");
                const blob = new Blob(["\uFEFF"+h+r], {type:'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a"); a.href=url; a.download=`releves_coteduparc_modern_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            }

            window.updateThermostat = function(drop) {
                currentThermostatDrop = drop;
                document.querySelectorAll('.thermostat-btn').forEach(btn => {
                    if (parseInt(btn.dataset.val) === drop) {
                        btn.className = 'thermostat-btn px-3 py-1.5 text-xs font-bold rounded-lg transition-all bg-emerald-500 text-white shadow-md shadow-emerald-200 dark:shadow-none';
                    } else {
                        btn.className = 'thermostat-btn px-3 py-1.5 text-xs font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800';
                    }
                });
                initData(); 
                renderDashboard(currentYearFilter);
            }

            window.renderDashboard = function(year) {
                currentYearFilter = year;
                document.querySelectorAll('#yearFilters button').forEach(b => {
                     b.className = `filter-btn px-4 py-1.5 rounded-lg text-xs font-semibold whitespace-nowrap ${b.dataset.year == year ? 'active' : 'text-slate-500 hover:text-slate-800 dark:hover:text-white'}`;
                });
                
                const data = year === 'all' ? allData : allData.filter(d => d.year == year);

                const sum = (t) => Math.round(data.filter(d=>d.type===t).reduce((a,b)=>a+b.conso,0));
                const cost = Math.round(data.reduce((a,b)=>a+b.cost,0));
                
                if(window.CountUp) {
                   new CountUp('kpi-elec', sum('Electricité'), {duration: 1.5}).start();
                   new CountUp('kpi-gaz', sum('Gaz'), {duration: 1.5}).start();
                   new CountUp('kpi-cost', cost, {suffix: ' €', duration: 1.5}).start();
                } else {
                   document.getElementById('kpi-cost').innerText = cost + ' €';
                }

                updateAnalysis(data);
                renderTable(data);
                renderChart(data);
            }

            function updateAnalysis(data) {
                let displayYear = currentYearFilter === 'all' ? '2026' : currentYearFilter;
                let isProjContext = parseInt(displayYear) >= 2026;
                let displayProvider = isProjContext ? 'Ohm' : 'Engie';

                let priceGaz = isProjContext ? CONFIG.tariffs.ohm.gas.kwh : CONFIG.tariffs.engie.gas.kwh;
                let priceElec = isProjContext ? CONFIG.tariffs.ohm.elec.kwh : CONFIG.tariffs.engie.elec.kwh;
                
                if(document.getElementById('analysis-gaz-label')) document.getElementById('analysis-gaz-label').innerHTML = `<i data-lucide="flame" class="w-4 h-4"></i> Gaz (${priceGaz.toFixed(3)}€)`;
                if(document.getElementById('analysis-elec-label')) document.getElementById('analysis-elec-label').innerHTML = `<i data-lucide="zap" class="w-4 h-4"></i> Élec (${priceElec.toFixed(3)}€)`;

                let factor = 1;
                if (currentYearFilter === 'all') {
                     const uniqueYears = new Set(data.map(d => d.year)).size;
                     factor = uniqueYears > 0 ? uniqueYears : 1;
                }
                
                const gaz = data.filter(d=>d.type==='Gaz').reduce((a,b)=>a+b.conso,0) / factor;
                const elec = data.filter(d=>d.type==='Electricité').reduce((a,b)=>a+b.conso,0) / factor;
                const dpe = Math.round((gaz+elec)/CONFIG.surface);
                
                if (document.getElementById('dpe-value')) {
                     if(window.CountUp) new CountUp('dpe-value', dpe).start();
                     else document.getElementById('dpe-value').innerText = dpe;
                }
                if(document.getElementById('dpe-title')) document.getElementById('dpe-title').innerText = `Perf. Moyenne (${dpe})`;

                let g = 'G';
                if(dpe<=70) g='A'; else if(dpe<=110) g='B'; else if(dpe<=180) g='C';
                else if(dpe<=250) g='D'; else if(dpe<=330) g='E'; else if(dpe<=420) g='F';
                
                const maxDPE = 450; 
                let deg = -90 + (Math.min(dpe, maxDPE) / maxDPE) * 180;
                if(document.getElementById('dpe-needle')) {
                    document.getElementById('dpe-needle').style.transform = `translateX(-50%) rotate(${deg}deg)`;
                }

                const badge = document.getElementById('dpe-grade-badge');
                if (badge) {
                    badge.innerText = g;
                    const colors = { A:'bg-emerald-500', B:'bg-emerald-400', C:'bg-emerald-300', D:'bg-yellow-400', E:'bg-orange-400', F:'bg-orange-500', G:'bg-red-500' };
                    badge.className = `w-8 h-8 rounded-lg text-white flex items-center justify-center font-black shadow-lg ${colors[g]} transition-colors duration-500`;
                }

                // ECONOMIES
                let gainTitle = "Gain 2026 Estimé";
                let gainSubtitle = "vs Engie 2025";
                let totalSavings = 0;
                let gainSupplier = 0;
                let gainThermo = 0;

                const proj2026 = allData.filter(d => d.year === 2026);
                const volGaz2026 = proj2026.filter(d => d.type === 'Gaz').reduce((a, b) => a + b.conso, 0);
                const volElec2026 = proj2026.filter(d => d.type === 'Electricité').reduce((a, b) => a + b.conso, 0);

                const costOhm = 
                    (volElec2026 * CONFIG.tariffs.ohm.elec.kwh + CONFIG.tariffs.ohm.elec.sub_m * 12) +
                    (volGaz2026 * CONFIG.tariffs.ohm.gas.kwh + CONFIG.tariffs.ohm.gas.sub_m * 12);

                const factorThermo = 1 / (1 - (currentThermostatDrop * 0.07)); 
                const volGazRef = volGaz2026 * factorThermo;
                
                const costEngieRef = 
                    (volElec2026 * CONFIG.tariffs.engie.elec.kwh + CONFIG.tariffs.engie.elec.sub_m * 12) +
                    (volGazRef * CONFIG.tariffs.engie.gas.kwh + CONFIG.tariffs.engie.gas.sub_m * 12);

                if (parseInt(displayYear) < 2026 && displayYear !== 'all') {
                    gainTitle = `Gain Virtuel ${displayYear}`;
                    gainSubtitle = "Si vous aviez été chez Ohm";
                    
                    const volGazYear = data.filter(d=>d.type==='Gaz').reduce((a,b)=>a+b.conso,0);
                    const volElecYear = data.filter(d=>d.type==='Electricité').reduce((a,b)=>a+b.conso,0);
                    const costReal = data.reduce((a,b)=>a+b.cost,0);
                    
                    const costOhmSim = (volElecYear * CONFIG.tariffs.ohm.elec.kwh + 12 * CONFIG.tariffs.ohm.elec.sub_m) +
                                       (volGazYear * CONFIG.tariffs.ohm.gas.kwh + 12 * CONFIG.tariffs.ohm.gas.sub_m);
                    
                    totalSavings = costReal - costOhmSim;
                    gainSupplier = totalSavings;
                    gainThermo = 0;
                } else {
                    totalSavings = costEngieRef - costOhm;
                    const costOhmBase = (volElec2026 * CONFIG.tariffs.ohm.elec.kwh + CONFIG.tariffs.ohm.elec.sub_m * 12) + (volGazRef * CONFIG.tariffs.ohm.gas.kwh + CONFIG.tariffs.ohm.gas.sub_m * 12);
                    gainSupplier = costEngieRef - costOhmBase;
                    gainThermo = costOhmBase - costOhm;
                }

                if(document.getElementById('gain-title')) document.getElementById('gain-title').innerText = gainTitle;
                if(document.getElementById('savings-subtitle')) document.getElementById('savings-subtitle').innerText = gainSubtitle;

                const savingsEl = document.getElementById('savings-value');
                if (savingsEl) {
                    const sign = totalSavings > 0 ? '+' : '';
                    if(window.CountUp) new CountUp('savings-value', Math.round(totalSavings), { prefix: sign, suffix: ' €' }).start();
                    else savingsEl.innerText = `${sign}${Math.round(totalSavings)} €`;
                    
                    if (totalSavings >= 0) {
                        savingsEl.classList.remove('text-red-500');
                        savingsEl.classList.add('text-emerald-600', 'dark:text-emerald-400');
                    } else {
                        savingsEl.classList.remove('text-emerald-600', 'dark:text-emerald-400');
                        savingsEl.classList.add('text-red-500');
                    }
                }
                
                if (document.getElementById('gain-elec')) document.getElementById('gain-elec').innerHTML = `<span class="font-bold">${gainSupplier > 0 ? '+' : ''}${Math.round(gainSupplier)} €</span>`;
                if (document.getElementById('gain-gaz')) document.getElementById('gain-gaz').innerHTML = `<span class="font-bold">${gainThermo > 0 ? '+' : ''}${Math.round(gainThermo)} €</span>`;

                const rG = gaz / (CONFIG.benchmarks.gaz.avg * 1.15); 
                const elG = document.getElementById('analysis-gaz-text');
                const bgG = document.getElementById('badge-gaz');
                const barG = document.getElementById('gauge-gaz');
                if (elG && bgG && barG) {
                    if(rG < 0.8) { elG.innerText = "Excellent. Vous êtes très économe."; bgG.innerText = "Top"; bgG.className = "px-2 py-0.5 rounded-md text-[10px] font-bold bg-emerald-100 text-emerald-700"; barG.style.width = "20%"; barG.className="h-full rounded-full bg-emerald-500"; } 
                    else if(rG < 1.1) { elG.innerText = "Cohérent avec la surface."; bgG.innerText = "Ok"; bgG.className = "px-2 py-0.5 rounded-md text-[10px] font-bold bg-blue-100 text-blue-700"; barG.style.width = "50%"; barG.className="h-full rounded-full bg-blue-500"; } 
                    else { elG.innerText = "Consommation élevée."; bgG.innerText = "Haut"; bgG.className = "px-2 py-0.5 rounded-md text-[10px] font-bold bg-orange-100 text-orange-700"; barG.style.width = "85%"; barG.className="h-full rounded-full bg-orange-500"; }
                }
                const rE = elec / CONFIG.benchmarks.elec.avg;
                const elE = document.getElementById('analysis-elec-text');
                const bgE = document.getElementById('badge-elec');
                const barE = document.getElementById('gauge-elec');
                if (elE && bgE && barE) {
                    if(rE < 0.9) { elE.innerText = "Très sobre."; bgE.innerText = "Top"; bgE.className = "px-2 py-0.5 rounded-md text-[10px] font-bold bg-emerald-100 text-emerald-700"; barE.style.width = "20%"; barE.className="h-full rounded-full bg-emerald-500"; } 
                    else if(rE < 1.3) { elE.innerText = "Standard."; bgE.innerText = "Ok"; bgE.className = "px-2 py-0.5 rounded-md text-[10px] font-bold bg-blue-100 text-blue-700"; barE.style.width = "50%"; barE.className="h-full rounded-full bg-blue-500"; } 
                    else { elE.innerText = "Élevé."; bgE.innerText = "Haut"; bgE.className = "px-2 py-0.5 rounded-md text-[10px] font-bold bg-orange-100 text-orange-700"; barE.style.width = "85%"; barE.className="h-full rounded-full bg-orange-500"; }
                }

                if(typeof lucide !== 'undefined') lucide.createIcons();
            }

            function renderTable(data) {
                const container = document.getElementById('records-container');
                if (!container) return;
                const sorted = [...data].sort((a,b)=>b.date-a.date);
                let html = `
                <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50/50 dark:bg-slate-800/50">
                        <tr>
                            <th class="px-6 py-3 text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider">Période</th>
                            <th class="px-6 py-3 text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-right text-[10px] font-bold text-slate-400 uppercase tracking-wider">Vol.</th>
                            <th class="px-6 py-3 text-right text-[10px] font-bold text-slate-400 uppercase tracking-wider">Coût</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">
                `;
                sorted.forEach(d => {
                    const isGaz = d.type === 'Gaz';
                    const icon = isGaz ? 'flame' : 'zap';
                    const iconColor = isGaz ? 'text-orange-500' : 'text-blue-500';
                    const rowClass = d.isProjection ? 'bg-slate-50/30 dark:bg-slate-800/20 italic text-slate-400' : 'hover:bg-slate-50/80 dark:hover:bg-slate-800/50 transition-colors'; 
                    const costDisplay = d.isProjection ? `~${d.cost.toFixed(0)} €` : `<strong>${d.cost.toFixed(2)} €</strong>`;
                    
                    html += `
                    <tr class="${rowClass}">
                        <td class="px-6 py-3 text-xs font-medium whitespace-nowrap">
                            ${d.rangeStr}
                            ${d.isProjection ? '<span class="ml-2 px-1.5 py-0.5 rounded text-[9px] bg-slate-200 dark:bg-slate-700 text-slate-500">PROJ</span>' : ''}
                        </td>
                        <td class="px-6 py-3">
                            <div class="flex items-center gap-2 text-xs font-semibold ${iconColor}">
                                <i data-lucide="${icon}" class="w-3 h-3"></i> ${d.type}
                            </div>
                        </td>
                        <td class="px-6 py-3 text-right text-xs font-medium text-slate-600 dark:text-slate-300">${Math.round(d.conso)} kWh</td>
                        <td class="px-6 py-3 text-right text-xs text-slate-700 dark:text-slate-200 font-mono">${costDisplay}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
                container.innerHTML = html;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function renderChart(data) {
                const ctx = document.getElementById('energyChart');
                if (!ctx) return;
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const groups = {};
                data.sort((a,b) => a.date - b.date);
                data.forEach(d => {
                    const k = d.date.toISOString().slice(0,7);
                    if(!groups[k]) {
                        groups[k] = { label: d.date.toLocaleDateString('fr',{month:'short', year:'2-digit'}), fullRange: d.rangeStr, gaz:0, elec:0, temp:d.temp, sort: d.date, isProjection: d.isProjection, provider: d.provider };
                    }
                    if(d.type==='Gaz') groups[k].gaz += d.conso; 
                    else groups[k].elec += d.conso;
                });
                const arr = Object.values(groups).sort((a,b)=>a.sort-b.sort);
                if(chartInstance) chartInstance.destroy();

                const gradientGaz = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradientGaz.addColorStop(0, 'rgba(249, 115, 22, 0.9)');
                gradientGaz.addColorStop(1, 'rgba(249, 115, 22, 0.4)');

                const gradientElec = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradientElec.addColorStop(0, 'rgba(59, 130, 246, 0.9)');
                gradientElec.addColorStop(1, 'rgba(59, 130, 246, 0.4)');
                
                // Opacity for projection
                const bgGaz = arr.map(d => d.isProjection ? 'rgba(249, 115, 22, 0.2)' : gradientGaz);
                const bgElec = arr.map(d => d.isProjection ? 'rgba(59, 130, 246, 0.2)' : gradientElec);
                const borders = arr.map(d => d.isProjection ? 2 : 0);

                const budgetLine = {
                    type: 'line',
                    yMin: 1000, yMax: 1000,
                    borderColor: 'rgba(239, 68, 68, 0.4)',
                    borderWidth: 1, borderDash: [4, 4],
                    label: { content: 'Cible', enabled: true, position: 'start', color: 'rgba(239, 68, 68, 0.7)', font: {size: 10} }
                };

                Chart.defaults.font.family = '"Plus Jakarta Sans", sans-serif';
                Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';

                chartInstance = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: arr.map(d=>d.label),
                        datasets: [
                            { label:'Gaz', data:arr.map(d=>d.gaz), backgroundColor: bgGaz, borderRadius: 4, barPercentage: 0.6, stack:'Stack 0', borderColor: '#f97316', borderWidth: borders },
                            { label:'Élec', data:arr.map(d=>d.elec), backgroundColor: bgElec, borderRadius: 4, barPercentage: 0.6, stack:'Stack 0', borderColor: '#3b82f6', borderWidth: borders }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { 
                            legend: { display: false }, 
                            annotation: { annotations: { line1: budgetLine } },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                padding: 12,
                                titleFont: { size: 13, weight: 'bold' },
                                bodyFont: { size: 12 },
                                cornerRadius: 8,
                                displayColors: true,
                                callbacks: { 
                                    title: (i) => `${arr[i[0].dataIndex].fullRange}`,
                                    label: (c) => `${c.dataset.label}: ${Math.round(c.raw)} kWh`
                                } 
                            } 
                        },
                        scales: { 
                            x: { grid:{display:false}, ticks:{font:{size:10}} }, 
                            y: { display:false, grid:{display:false} } 
                        }
                    }
                });
            }

            initData();
            updateThermostat(0);
        });
    </script>
</body>
</html>
