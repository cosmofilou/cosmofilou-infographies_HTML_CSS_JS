<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi & Projection Énergétique 2026 - Côté Parc</title>
    
    <!-- Tailwind CSS Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { slate: { 850: '#151e2e' } }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        @media (prefers-color-scheme: dark) {
            .glass-card {
                background: rgba(30, 41, 59, 0.85);
                border-color: rgba(51, 65, 85, 0.8);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .filter-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); white-space: nowrap; }
        .filter-btn.active { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: white; border-color: transparent; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transform: scale(1.05);
        }

        .dpe-cursor { 
            position: absolute; top: -12px; width: 4px; height: calc(100% + 24px); 
            background: #1e293b; border-radius: 2px;
            transform: translateX(-50%); transition: left 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 10;
        }
        @media (prefers-color-scheme: dark) { .dpe-cursor { background: #f8fafc; } }

        .gauge-fill { height: 100%; border-radius: 9999px; transition: width 1s ease-out; position: relative; overflow: hidden; }
        .gauge-fill::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
        }
    </style>
</head>
<body class="bg-[#f0f4f8] text-slate-800 dark:bg-[#0f172a] dark:text-slate-200 antialiased flex flex-col min-h-screen">

    <!-- En-tête -->
    <header class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md sticky top-0 z-30 border-b border-slate-200 dark:border-slate-800 shadow-sm w-full">
        <div class="px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4 w-full">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-indigo-600 rounded-xl text-white shadow-lg shadow-indigo-500/30 flex-shrink-0">
                        <i data-lucide="home" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-extrabold text-slate-900 dark:text-white leading-tight">Résidence Côté Parc</h1>
                        <div class="flex flex-wrap items-center gap-x-2 gap-y-1 text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5">
                            <span>Suivi & Projection 2026</span>
                            <span class="text-slate-300 dark:text-slate-700">|</span>
                            <span class="text-emerald-600 dark:text-emerald-400 flex items-center gap-1">
                                <i data-lucide="check-circle" class="w-3 h-3"></i> MAJ <span id="last-updated-date">--/--</span>
                            </span>
                        </div>
                    </div>
                </div>
                <button onclick="exportToCSV()" class="md:hidden p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300">
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex items-center gap-3 w-full md:w-auto overflow-hidden justify-end">
                <div class="overflow-x-auto hide-scrollbar flex-grow md:flex-grow-0">
                    <div class="flex gap-2" id="yearFilters"></div>
                </div>
                <button onclick="exportToCSV()" class="hidden md:flex p-2 md:px-3 md:py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-slate-600 dark:text-slate-300 items-center gap-2 flex-shrink-0">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span class="text-xs font-semibold">Export CSV</span>
                </button>
            </div>
        </div>
    </header>

    <main class="w-full px-4 py-6 space-y-6 flex-grow">
        
        <!-- ROW 1: 3 Tuiles Alignées -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
            
            <!-- Tuile 1 : Fiche Logement -->
            <div class="glass-card rounded-2xl p-5 border-l-4 border-indigo-500 justify-center">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Fiche Logement</h3>
                    <i data-lucide="map-pin" class="w-4 h-4 text-indigo-500"></i>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-slate-600 dark:text-slate-300">
                            <i data-lucide="maximize" class="w-4 h-4 text-slate-400"></i> <span class="text-sm font-medium">Surface</span>
                        </div>
                        <span class="font-bold text-slate-900 dark:text-white">42 m² (T2)</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-slate-600 dark:text-slate-300">
                            <i data-lucide="arrow-down-to-line" class="w-4 h-4 text-slate-400"></i> <span class="text-sm font-medium">Position</span>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-slate-600 dark:text-slate-300">RDC sur Parking</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-slate-600 dark:text-slate-300">
                            <i data-lucide="compass" class="w-4 h-4 text-slate-400"></i> <span class="text-sm font-medium">Orientation</span>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 rounded border border-blue-100 dark:border-blue-800">Nord-Est</span>
                    </div>
                </div>
            </div>

            <!-- Tuile 2 : Performance DPE -->
            <div class="glass-card rounded-2xl p-5 relative overflow-hidden justify-between border-t-4 border-slate-400 dark:border-slate-600">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="leaf" class="w-24 h-24"></i></div>
                <div class="flex justify-between items-end mb-4 relative z-10">
                    <div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Performance</h3>
                        <div class="flex items-baseline gap-2">
                            <span id="dpe-value" class="text-3xl font-extrabold text-slate-900 dark:text-white">--</span>
                            <span class="text-sm font-medium text-slate-500">kWh/m²/an</span>
                        </div>
                    </div>
                    <div id="dpe-grade-badge" class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-2xl font-black text-slate-800 dark:text-white shadow-sm border border-slate-200 dark:border-slate-700">-</div>
                </div>
                <div>
                    <div class="h-4 flex rounded-full overflow-hidden shadow-inner mt-2">
                        <div class="bg-emerald-500 w-[14%]"></div>
                        <div class="bg-emerald-400 w-[14%]"></div>
                        <div class="bg-emerald-200 w-[14%]"></div>
                        <div class="bg-yellow-400 w-[14%]"></div>
                        <div class="bg-orange-400 w-[14%]"></div>
                        <div class="bg-orange-600 w-[14%]"></div>
                        <div class="bg-red-600 w-[16%]"></div>
                    </div>
                    <div class="relative h-4 mt-1">
                        <div id="dpe-cursor" class="dpe-cursor"></div>
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 px-1 mt-1"><span>A</span><span>D</span><span>G</span></div>
                    </div>
                </div>
            </div>

            <!-- Tuile 3 : Gain Estimé -->
            <div class="glass-card rounded-2xl p-5 border-l-4 border-emerald-500 flex flex-col justify-center bg-emerald-50/50 dark:bg-emerald-900/10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-widest">Gain Est. 2026</h3>
                    <div class="bg-emerald-100 dark:bg-emerald-800 p-1.5 rounded-full text-emerald-600 dark:text-emerald-300">
                        <i data-lucide="trending-down" class="w-4 h-4"></i>
                    </div>
                </div>
                <div>
                    <p class="text-3xl font-extrabold text-emerald-700 dark:text-emerald-300 mb-1" id="savings-value">Calcul...</p>
                    <p class="text-xs text-emerald-600/80 dark:text-emerald-400/80 font-medium">vs si resté chez Engie (An)</p>
                </div>
                <div class="mt-4 pt-3 border-t border-emerald-100 dark:border-emerald-800/30 flex justify-between text-xs">
                    <span class="text-emerald-600 dark:text-emerald-400">Élec: <strong id="gain-elec">...</strong></span>
                    <span class="text-emerald-600 dark:text-emerald-400">Gaz: <strong id="gain-gaz">...</strong></span>
                </div>
            </div>
        </div>

        <!-- ROW 2: CHART & DETAILS -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 w-full">
            
            <!-- Graphique & KPIs (2/3) -->
            <div class="glass-card rounded-2xl p-0 xl:col-span-2 overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm">Historique & Projection</h3>
                    <div class="flex gap-4 text-xs">
                        <div class="flex flex-col items-end">
                            <span class="text-slate-400 font-bold uppercase tracking-wider">Élec</span>
                            <span class="font-bold text-blue-600 dark:text-blue-400" id="kpi-elec">...</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-slate-400 font-bold uppercase tracking-wider">Gaz</span>
                            <span class="font-bold text-orange-600 dark:text-orange-400" id="kpi-gaz">...</span>
                        </div>
                        <div class="flex flex-col items-end border-l border-slate-200 dark:border-slate-700 pl-4">
                            <span class="text-slate-400 font-bold uppercase tracking-wider">Total</span>
                            <span class="font-bold text-emerald-600 dark:text-emerald-400" id="kpi-cost">...</span>
                        </div>
                    </div>
                </div>
                <div class="p-4 flex-grow min-h-[350px]">
                    <div class="h-full w-full relative">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Analyse (1/3) -->
            <div class="glass-card rounded-2xl p-6 xl:col-span-1 border-t-4 border-slate-900 dark:border-slate-600">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2 mb-6">
                    <i data-lucide="stethoscope" class="text-indigo-500"></i> Analyse 2026
                </h3>
                
                <div class="space-y-8">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2 text-orange-600 dark:text-orange-400 font-bold text-sm">
                                <i data-lucide="flame" class="w-4 h-4"></i> Gaz (0,134€/kWh)
                            </div>
                            <span id="badge-gaz" class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600">...</span>
                        </div>
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-2 mb-1 text-xs flex rounded-full bg-slate-200 dark:bg-slate-700">
                                <div id="gauge-gaz" class="gauge-fill bg-gradient-to-r from-orange-400 to-orange-600" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-[10px] font-semibold text-slate-400"><span>Éco</span><span>Moyen</span><span>Haut</span></div>
                        </div>
                        <p id="analysis-gaz-text" class="text-xs text-slate-500 dark:text-slate-400 mt-2 italic leading-tight">...</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2 text-blue-600 dark:text-blue-400 font-bold text-sm">
                                <i data-lucide="zap" class="w-4 h-4"></i> Élec (0,179€/kWh)
                            </div>
                            <span id="badge-elec" class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600">...</span>
                        </div>
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-2 mb-1 text-xs flex rounded-full bg-slate-200 dark:bg-slate-700">
                                <div id="gauge-elec" class="gauge-fill bg-gradient-to-r from-blue-400 to-blue-600" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-[10px] font-semibold text-slate-400"><span>Éco</span><span>Moyen</span><span>Haut</span></div>
                        </div>
                        <p id="analysis-elec-text" class="text-xs text-slate-500 dark:text-slate-400 mt-2 italic leading-tight">...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3: RECORDS -->
        <div class="glass-card rounded-2xl overflow-hidden w-full">
            <div class="px-6 py-4 bg-slate-50/50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Détail des factures</h3>
            </div>
            <div id="records-container" class="p-0"></div>
        </div>

    </main>

    <footer class="mt-auto py-6 text-center border-t border-slate-200 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50 w-full">
        <p class="text-xs text-slate-500">© 2026 • Données Personnelles • Généré par IA</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CONFIG & TARIFS
            const CONFIG = {
                surface: 42,
                benchmarks: {
                    gaz: { avg: 110 * 42, max: 150 * 42 },
                    elec: { avg: 1800, max: 3000 }
                },
                tariffs: {
                    engie: { elec: { kwh: 0.2276, sub_m: 13.00 }, gas: { kwh: 0.1082, sub_m: 21.00 } },
                    ohm: { elec: { kwh: 0.1794, sub_m: 16.79 }, gas: { kwh: 0.1340, sub_m: 10.95 } }
                }
            };

            const csvData = `Date_Facture;Période_Debut;Période_Fin;Type_Energie;Index_Debut;Index_Fin;Conso_kWh;Prix_Unitaire_HT;Montant_TTC;Type_Estime_Reel
03/12/2025;01/10/2025;30/11/2025;Gaz;3102;3143;462;0,04608;112,66;Réel
03/12/2025;03/10/2025;02/12/2025;Electricité;9379;9648;269;0,10281;88,67;Réel
03/10/2025;01/08/2025;30/09/2025;Gaz;3085;3102;194;0,04608;82,88;Réel
03/10/2025;03/08/2025;02/10/2025;Electricité;9161;9379;218;0,10281;70,57;Réel
03/08/2025;01/06/2025;31/07/2025;Gaz;3068;3085;192;0,04608;82,35;Réel
03/08/2025;03/06/2025;02/08/2025;Electricité;8924;9161;237;0,10281;74,64;Réel
03/06/2025;01/04/2025;31/05/2025;Gaz;3037;3068;346;0,04608;89,21;Réel
03/06/2025;03/04/2025;02/06/2025;Electricité;8688;8924;236;0,10281;71,77;Réel
03/04/2025;01/02/2025;31/03/2025;Gaz;2951;3037;962;0,04608;154,23;Réel
03/04/2025;03/02/2025;02/04/2025;Electricité;8421;8688;267;0,10281;94,87;Réel
03/02/2025;01/12/2024;31/01/2025;Gaz;2818;2951;1500;0,04608;205,07;Réel
03/02/2025;03/12/2024;02/02/2025;Electricité;8180;8421;241;0,10281;75,34;Réel
03/12/2024;26/09/2024;30/11/2024;Gaz;2737;2818;919;0,06548;141,72;Réel
03/12/2024;03/10/2024;02/12/2024;Electricité;7947;8180;233;0,12701;68,56;Réel
03/10/2024;01/08/2024;25/09/2024;Gaz;2717;2737;226;0,06548;71,70;Réel
03/10/2024;03/08/2024;02/10/2024;Electricité;7743;7947;204;0,12701;61,72;Réel
04/08/2024;01/06/2024;31/07/2024;Gaz;2689;2717;311;0,06548;83,37;Réel
04/08/2024;03/06/2024;02/08/2024;Electricité;7512;7743;231;0,12701;66,52;Réel
04/06/2024;01/04/2024;31/05/2024;Gaz;2625;2689;714;0,06548;112,25;Réel
04/06/2024;03/04/2024;02/06/2024;Electricité;7297;7512;215;0,12701;62,88;Réel
03/04/2024;01/02/2024;31/03/2024;Gaz;2534;2625;1010;0,06548;141,21;Estimé
03/04/2024;03/02/2024;02/04/2024;Electricité;7064;7297;233;0,12701;68,31;Réel
04/02/2024;30/11/2023;31/01/2024;Gaz;2397;2534;1542;0,06548;185,74;Réel
04/02/2024;03/12/2023;02/02/2024;Electricité;6816;7064;248;0,12701;64,95;Réel
03/12/2023;01/10/2023;29/11/2023;Gaz;2341;2397;625;0,06548;97,99;Réel
03/12/2023;03/10/2023;02/12/2023;Electricité;6574;6816;242;0,12701;64,56;Réel
04/10/2023;01/08/2023;30/09/2023;Gaz;2316;2341;283;0,06548;67,20;Réel
04/10/2023;03/08/2023;02/10/2023;Electricité;6342;6574;232;0,12701;62,63;Réel
04/08/2023;31/05/2023;31/07/2023;Gaz;2295;2316;235;0,06548;63,48;Estimé
04/08/2023;03/06/2023;02/08/2023;Electricité;6111;6342;231;0,12701;62,33;Réel
04/06/2023;01/04/2023;30/05/2023;Gaz;2223;2295;808;0,06548;112,33;Réel
04/06/2023;03/04/2023;02/06/2023;Electricité;5832;6111;279;0,12701;69,17;Réel
03/04/2023;01/02/2023;31/03/2023;Gaz;2071;2223;1706;0,06548;191,83;Réel
03/04/2023;03/02/2023;02/04/2023;Electricité;5524;5832;308;0,12701;70,96;Réel
03/02/2023;01/12/2022;31/01/2023;Gaz;1926;2071;1619;0,06548;183,29;Réel
03/02/2023;03/12/2022;02/02/2023;Electricité;5212;5524;312;0,12701;73,46;Réel`;

            const tempNantesMap = { 1:6.0, 2:6.5, 3:9.0, 4:11.5, 5:15.0, 6:18.5, 7:20.5, 8:20.5, 9:17.5, 10:14.0, 11:9.5, 12:6.5 };

            let allData = [];
            let chartInstance = null;

            const parseFrFloat = (s) => parseFloat(s.replace(',', '.'));
            const parseFrDate = (s) => { const p = s.split('/'); return new Date(p[2], p[1]-1, p[0]); };
            const formatDateShort = (d) => d.toLocaleDateString('fr',{day:'2-digit', month:'2-digit'});

            function generateProjection2026(historicalData) {
                const projections = [];
                // ADDING LATE 2025 PROJECTION WITH ENGIE (1 month)
                const relevantPastDec = historicalData.filter(d => d.date.getMonth() === 11); 
                const getAvg = (t) => {
                    const f = relevantPastDec.filter(d => d.type === t);
                    return f.length ? f.reduce((a,b)=>a+b.conso,0)/f.length : (t==='Gaz'?800:300);
                };
                // Projection Dec 2025 (1 mois) -> div 2
                const avgGazDec = getAvg('Gaz') / 2; 
                const avgElecDec = getAvg('Electricité') / 2;
                
                projections.push({
                    date: new Date(2025, 11, 1), endDate: new Date(2025, 11, 31),
                    dateStr: '01/01/2026', rangeStr: '01/12 - 31/12 (Est. Engie)', year: 2025, type: 'Gaz', conso: avgGazDec,
                    cost: (avgGazDec * CONFIG.tariffs.engie.gas.kwh) + (CONFIG.tariffs.engie.gas.sub_m), 
                    temp: 6.5, isProjection: true
                });
                projections.push({
                    date: new Date(2025, 11, 1), endDate: new Date(2025, 11, 31),
                    dateStr: '01/01/2026', rangeStr: '01/12 - 31/12 (Est. Engie)', year: 2025, type: 'Electricité', conso: avgElecDec,
                    cost: (avgElecDec * CONFIG.tariffs.engie.elec.kwh) + (CONFIG.tariffs.engie.elec.sub_m), 
                    temp: 6.5, isProjection: true
                });

                // 2026 OHM PROJECTIONS (Bimestriel)
                const periods = [
                    { m: 1, label: '01/02/2026', range: '01/01 - 28/02', month_range: [1,2] },
                    { m: 3, label: '01/04/2026', range: '01/03 - 30/04', month_range: [3,4] },
                    { m: 5, label: '01/06/2026', range: '01/05 - 30/06', month_range: [5,6] },
                    { m: 7, label: '01/08/2026', range: '01/07 - 31/08', month_range: [7,8] },
                    { m: 9, label: '01/10/2026', range: '01/09 - 31/10', month_range: [9,10] },
                    { m: 11, label: '01/12/2026', range: '01/11 - 31/12', month_range: [11,12] }
                ];

                periods.forEach(p => {
                    const relevantPastData = historicalData.filter(d => d.date.getMonth() === p.m || d.date.getMonth() === p.m - 1 || d.date.getMonth() === p.m + 1);
                    const getAvgConso = (type) => {
                        const filtered = relevantPastData.filter(d => d.type === type);
                        if(filtered.length === 0) return type === 'Gaz' ? 200 : 250;
                        const sum = filtered.reduce((a, b) => a + b.conso, 0);
                        return sum / filtered.length;
                    };
                    const avgGaz = getAvgConso('Gaz');
                    const avgElec = getAvgConso('Electricité');
                    const temp = (tempNantesMap[p.month_range[0]] + tempNantesMap[p.month_range[1]]) / 2;

                    projections.push({
                        date: parseFrDate(p.label), endDate: parseFrDate(p.label),
                        dateStr: p.label, rangeStr: p.range + ' (Proj.)', year: 2026, type: 'Gaz', conso: avgGaz,
                        cost: (avgGaz * CONFIG.tariffs.ohm.gas.kwh) + (CONFIG.tariffs.ohm.gas.sub_m * 2), temp: temp, isProjection: true
                    });
                    projections.push({
                        date: parseFrDate(p.label), endDate: parseFrDate(p.label),
                        dateStr: p.label, rangeStr: p.range + ' (Proj.)', year: 2026, type: 'Electricité', conso: avgElec,
                        cost: (avgElec * CONFIG.tariffs.ohm.elec.kwh) + (CONFIG.tariffs.ohm.elec.sub_m * 2), temp: temp, isProjection: true
                    });
                });
                return projections;
            }

            function initData() {
                const rows = csvData.trim().split('\n').slice(1);
                let parsed = rows.map(r => {
                    const c = r.split(';');
                    const d1 = parseFrDate(c[1]), d2 = parseFrDate(c[2]);
                    const t1 = tempNantesMap[d1.getMonth()+1], t2 = tempNantesMap[d2.getMonth()+1];
                    return {
                        date: d1, endDate: d2, dateStr: c[1],
                        rangeStr: `${formatDateShort(d1)} - ${formatDateShort(d2)}`,
                        year: d1.getFullYear(), type: c[3], conso: parseFrFloat(c[6]), cost: parseFrFloat(c[8]), temp: (t1+t2)/2, isProjection: false
                    };
                });
                const proj = generateProjection2026(parsed);
                allData = [...parsed, ...proj].sort((a,b) => a.date - b.date);
                const realData = allData.filter(d => !d.isProjection);
                if(realData.length) {
                    const max = new Date(Math.max(...realData.map(e=>e.endDate)));
                    if (document.getElementById('last-updated-date'))
                        document.getElementById('last-updated-date').innerText = max.toLocaleDateString('fr-FR');
                }
            }

            window.exportToCSV = function() {
                const h = "Date;Période;Type;kWh;Euro;Temp;Statut\n";
                const r = allData.map(d => `${d.date.toLocaleDateString()};${d.rangeStr};${d.type};${d.conso.toFixed(0)};${d.cost.toFixed(2)};${d.temp.toFixed(1)};${d.isProjection?'Projection':'Réel'}`).join("\n");
                const blob = new Blob(["\uFEFF"+h+r], {type:'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a"); a.href=url; a.download=`releves_coteduparc_proj2026_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            }

            function renderDashboard(year) {
                const data = year === 'all' ? allData : allData.filter(d => d.year == year);
                const years = [...new Set(allData.map(d=>d.year))].sort();
                const fContainer = document.getElementById('yearFilters');
                fContainer.innerHTML = '';
                
                const mkBtn = (lbl, val) => {
                    const b = document.createElement('button');
                    b.innerText=lbl; b.dataset.year=val; 
                    b.className = `filter-btn px-4 py-2 rounded-xl text-sm font-semibold transition-all shadow-sm ${val == year 
                        ? 'active ring-2 ring-blue-500 ring-offset-2' 
                        : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-50'}`;
                    b.onclick=()=>renderDashboard(val);
                    fContainer.appendChild(b);
                };
                mkBtn('Tout', 'all');
                years.forEach(y => mkBtn(y, y));

                const sum = (t) => Math.round(data.filter(d=>d.type===t).reduce((a,b)=>a+b.conso,0));
                const cost = Math.round(data.reduce((a,b)=>a+b.cost,0));
                if (document.getElementById('kpi-elec')) document.getElementById('kpi-elec').innerText = sum('Electricité');
                if (document.getElementById('kpi-gaz')) document.getElementById('kpi-gaz').innerText = sum('Gaz');
                if (document.getElementById('kpi-cost')) document.getElementById('kpi-cost').innerText = cost + ' €';

                updateAnalysis(data);
                renderTable(data);
                renderChart(data);
            }

            function updateAnalysis(data) {
                const realData = data.filter(d => !d.isProjection);
                const workingData = realData.length > 0 ? realData : data;
                let factor = workingData.length > 20 ? 3 : (workingData.length > 6 ? 1 : 0.5); 
                const gaz = workingData.filter(d=>d.type==='Gaz').reduce((a,b)=>a+b.conso,0) / factor;
                const elec = workingData.filter(d=>d.type==='Electricité').reduce((a,b)=>a+b.conso,0) / factor;
                const dpe = Math.round((gaz+elec)/CONFIG.surface);
                if (document.getElementById('dpe-value')) document.getElementById('dpe-value').innerText = dpe;
                
                let g = 'G', p = 92;
                if(dpe<=70){g='A';p=7} else if(dpe<=110){g='B';p=21} else if(dpe<=180){g='C';p=35}
                else if(dpe<=250){g='D';p=50} else if(dpe<=330){g='E';p=64} else if(dpe<=420){g='F';p=78}
                if (document.getElementById('dpe-cursor')) document.getElementById('dpe-cursor').style.left = p+'%';
                const badge = document.getElementById('dpe-grade-badge');
                if (badge) {
                    badge.innerText = g;
                    const colors = { A:'text-green-600 bg-green-50', B:'text-green-500 bg-green-50', C:'text-green-400 bg-green-50', D:'text-yellow-600 bg-yellow-50', E:'text-orange-500 bg-orange-50', F:'text-orange-600 bg-orange-50', G:'text-red-600 bg-red-50' };
                    badge.className = `px-4 py-2 rounded-xl text-2xl font-black shadow-sm border border-slate-200 dark:border-slate-700 ${colors[g]}`;
                }

                const annualCostOhmElec = (elec * CONFIG.tariffs.ohm.elec.kwh) + (CONFIG.tariffs.ohm.elec.sub_m * 12);
                const annualCostEngieElec = (elec * CONFIG.tariffs.engie.elec.kwh) + (CONFIG.tariffs.engie.elec.sub_m * 12);
                const savingElec = annualCostEngieElec - annualCostOhmElec;
                const annualCostOhmGas = (gaz * CONFIG.tariffs.ohm.gas.kwh) + (CONFIG.tariffs.ohm.gas.sub_m * 12);
                const annualCostEngieGas = (gaz * CONFIG.tariffs.engie.gas.kwh) + (CONFIG.tariffs.engie.gas.sub_m * 12);
                const savingGas = annualCostEngieGas - annualCostOhmGas; 
                const totalSavings = savingElec + savingGas;

                const savingsEl = document.getElementById('savings-value');
                if (savingsEl) {
                    savingsEl.innerText = `${Math.round(totalSavings)} € / an`;
                    savingsEl.className = totalSavings > 0 ? "text-3xl font-extrabold text-emerald-700 dark:text-emerald-300 mb-1" : "text-3xl font-extrabold text-red-700 dark:text-red-300 mb-1";
                }
                if (document.getElementById('gain-elec')) document.getElementById('gain-elec').innerText = `${savingElec > 0 ? '+' : ''}${Math.round(savingElec)} €`;
                if (document.getElementById('gain-gaz')) document.getElementById('gain-gaz').innerText = `${savingGas > 0 ? '+' : ''}${Math.round(savingGas)} €`;

                const rG = gaz / (CONFIG.benchmarks.gaz.avg * 1.15); 
                const elG = document.getElementById('analysis-gaz-text');
                const bgG = document.getElementById('badge-gaz');
                const barG = document.getElementById('gauge-gaz');
                if (elG && bgG && barG) {
                    if(rG < 0.8) { elG.innerText = "Excellente performance thermique."; bgG.className = "px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700"; bgG.innerText = "Économe"; barG.style.width = "15%"; } 
                    else if(rG < 1.1) { elG.innerText = "Consommation cohérente."; bgG.className = "px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700"; bgG.innerText = "Normal"; barG.style.width = "50%"; } 
                    else { elG.innerText = "Attention, consommation élevée."; bgG.className = "px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700"; bgG.innerText = "Élevé"; barG.style.width = "85%"; }
                }
                const rE = elec / CONFIG.benchmarks.elec.avg;
                const elE = document.getElementById('analysis-elec-text');
                const bgE = document.getElementById('badge-elec');
                const barE = document.getElementById('gauge-elec');
                if (elE && bgE && barE) {
                    if(rE < 0.9) { elE.innerText = "Très sobre."; bgE.className = "px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700"; bgE.innerText = "Sobre"; barE.style.width = "15%"; } 
                    else if(rE < 1.3) { elE.innerText = "Dans la moyenne nationale."; bgE.className = "px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700"; bgE.innerText = "Standard"; barE.style.width = "50%"; } 
                    else { elE.innerText = "Consommation importante."; bgE.className = "px-2.5 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700"; bgE.innerText = "Haut"; barE.style.width = "85%"; }
                }
            }

            function renderTable(data) {
                const container = document.getElementById('records-container');
                if (!container) return;
                const sorted = [...data].sort((a,b)=>b.date-a.date);
                let html = `
                <table class="w-full hidden md:table">
                    <thead class="bg-slate-50 dark:bg-slate-800">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Période</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Fournisseur</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Énergie</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Volume</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Coût</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-900">
                `;
                sorted.forEach(d => {
                    const isGaz = d.type === 'Gaz';
                    const color = isGaz ? 'text-orange-600 bg-orange-50' : 'text-blue-600 bg-blue-50';
                    const rowClass = d.isProjection ? 'bg-slate-50/50 dark:bg-slate-800/30 text-slate-500' : 'hover:bg-slate-50 dark:hover:bg-slate-800'; 
                    const costDisplay = d.isProjection ? `~${d.cost.toFixed(0)} €` : `${d.cost.toFixed(2)} €`;
                    const provider = d.year >= 2026 ? 'Ohm' : 'Engie';
                    const providerClass = d.year >= 2026 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                    html += `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-6 py-4 text-sm font-medium text-slate-700 dark:text-slate-300">
                            ${d.rangeStr}
                            ${d.isProjection ? '<span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-800">PROJ</span>' : ''}
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold ${providerClass}">${provider}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-bold ${color}">${d.type}</span>
                        </td>
                        <td class="px-6 py-4 text-sm font-bold text-slate-700 dark:text-slate-200">${Math.round(d.conso)} kWh</td>
                        <td class="px-6 py-4 text-right text-sm font-mono text-slate-600 dark:text-slate-400">${costDisplay}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                html += `<div class="md:hidden space-y-3 p-4 bg-slate-50 dark:bg-slate-900/50">`;
                sorted.forEach(d => {
                    const isGaz = d.type === 'Gaz';
                    const icon = isGaz ? 'flame' : 'zap';
                    const colorClass = isGaz ? 'text-orange-600' : 'text-blue-600';
                    const borderClass = isGaz ? 'border-l-4 border-orange-500' : 'border-l-4 border-blue-500';
                    const opacityClass = d.isProjection ? 'opacity-75 border-l-2 border-dashed' : '';
                    const costDisplay = d.isProjection ? `~${d.cost.toFixed(0)} €` : `${d.cost.toFixed(2)} €`;
                    const provider = d.year >= 2026 ? 'Ohm' : 'Engie';
                    const providerClass = d.year >= 2026 ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                    html += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm ${borderClass} ${opacityClass} flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <p class="text-xs text-slate-400 font-semibold">${d.rangeStr}</p>
                                <span class="text-[10px] px-1.5 py-0.5 rounded font-bold ${providerClass}">${provider}</span>
                            </div>
                            <div class="flex items-center gap-2 ${colorClass} font-bold text-sm">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                                <span>${d.type}</span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">${d.temp.toFixed(1)}°C ext.</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-slate-800 dark:text-white">${Math.round(d.conso)} <span class="text-xs font-normal">kWh</span></p>
                            <p class="text-sm font-mono text-slate-600 dark:text-slate-400">${costDisplay}</p>
                        </div>
                    </div>`;
                });
                html += `</div>`;
                container.innerHTML = html;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function renderChart(data) {
                const ctx = document.getElementById('energyChart');
                if (!ctx) return;
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const groups = {};
                data.forEach(d => {
                    const k = d.date.toISOString().slice(0,7);
                    if(!groups[k]) groups[k] = { label: d.date.toLocaleDateString('fr',{month:'short', year:'2-digit'}), fullRange: `${d.rangeStr}`, gaz:0, elec:0, temp:d.temp, sort: d.date, isProjection: d.isProjection, provider: d.year >= 2026 ? 'Ohm' : 'Engie' };
                    if(d.type==='Gaz') groups[k].gaz += d.conso; else groups[k].elec += d.conso;
                });
                const arr = Object.values(groups).sort((a,b)=>a.sort-b.sort);
                if(chartInstance) chartInstance.destroy();
                const bgGaz = arr.map(d => d.isProjection ? 'rgba(249, 115, 22, 0.4)' : '#f97316');
                const bgElec = arr.map(d => d.isProjection ? 'rgba(59, 130, 246, 0.4)' : '#3b82f6');
                const borderGaz = arr.map(d => d.isProjection ? '#f97316' : '#f97316');
                const borderWidth = arr.map(d => d.isProjection ? 2 : 0);
                chartInstance = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: arr.map(d=>d.label),
                        datasets: [
                            { 
                                label:'Gaz', 
                                data:arr.map(d=>d.gaz), 
                                backgroundColor: bgGaz, 
                                borderColor: borderGaz, 
                                borderWidth: borderWidth, 
                                borderSkipped: false, 
                                borderRadius:4, 
                                stack:'Stack 0' // Explicit Stack ID for true stacking
                            },
                            { 
                                label:'Élec', 
                                data:arr.map(d=>d.elec), 
                                backgroundColor: bgElec, 
                                borderColor: '#3b82f6', 
                                borderWidth: borderWidth, 
                                borderSkipped: false, 
                                borderRadius:4, 
                                stack:'Stack 0' // Same Stack ID to enforce stacking
                            },
                            { 
                                label:'Temp', 
                                data:arr.map(d=>d.temp), 
                                type:'line', 
                                borderDash: [5, 5], 
                                borderColor: isDark ? '#94a3b8':'#475569', 
                                pointBackgroundColor: isDark ? '#94a3b8':'#475569', 
                                borderWidth:2, 
                                yAxisID:'y1' 
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position:'bottom', labels: { color: isDark ? '#cbd5e1':'#334155', usePointStyle:true } }, tooltip: { callbacks: { title: (items) => { const item = items[0]; const p = arr[item.dataIndex].provider; return `${arr[item.dataIndex].fullRange} (${p})`; }, label: (context) => { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null) label += Math.round(context.parsed.y) + (context.dataset.type === 'line' ? ' °C' : ' kWh'); if (arr[context.dataIndex].isProjection && context.dataset.type !== 'line') label += ' (Est.)'; return label; } } } },
                        scales: { 
                            x: { 
                                grid:{display:false}, 
                                ticks:{color: isDark ? '#94a3b8':'#64748b'},
                                stacked: true // Force Stacking X
                            }, 
                            y: { 
                                display:false,
                                stacked: true // Force Stacking Y
                            }, 
                            y1: { 
                                display:false, 
                                reverse:true 
                            } 
                        }
                    }
                });
            }

            initData();
            renderDashboard('all');
        });
    </script>
</body>
</html>
