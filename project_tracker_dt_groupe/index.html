<!DOCTYPE html>
<html class="antialiased">
  <head>
    <base target="_top">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
      tailwind.config = {
        darkMode: 'media', 
        theme: {
          extend: {
            colors: {
              // Salesforce-like Blue Palette - Adjusted for better dark mode contrast
              brand: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                200: '#bae6fd',
                300: '#7dd3fc',
                400: '#38bdf8',
                500: '#0ea5e9',
                600: '#0284c7', // Primary Light Mode
                700: '#0369a1',
                800: '#075985',
                900: '#0c4a6e',
                950: '#082f49',
              }
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
            screens: {
              'xs': '480px',
            }
          }
        }
      }
    </script>

    <style>
      /* CRITICAL FIX: Hide raw templates before Vue loads */
      [v-cloak] { display: none !important; }

      /* Professional Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

      @media (prefers-color-scheme: dark) {
        ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      }
      
      .loader {
        border-top-color: #0284c7; /* Brand Blue */
        animation: spinner 1.5s linear infinite;
      }
      @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
      .fade-enter-from, .fade-leave-to { opacity: 0; }

      .list-enter-active, .list-leave-active { transition: all 0.3s ease; }
      .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
      
      input[type="date"] {
        -webkit-appearance: none;
        min-height: 2.5rem; 
      }
      input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; }
      @media (prefers-color-scheme: dark) {
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
      }

      .ghost-card { opacity: 0.5; background: #f1f5f9; border: 2px dashed #94a3b8; }
      @media (prefers-color-scheme: dark) {
        .ghost-card { background: #1e293b; border-color: #64748b; }
      }
      
      .drag-handle { cursor: grab; }
      .drag-handle:active { cursor: grabbing; }
      
      .project-drag-handle { cursor: move; color: #94a3b8; touch-action: none; padding: 10px; }
      .project-drag-handle:hover { color: #64748b; background-color: #f1f5f9; border-radius: 6px;}
      @media (prefers-color-scheme: dark) {
        .project-drag-handle { color: #64748b; }
        .project-drag-handle:hover { color: #e2e8f0; background-color: #334155; }
      }

      /* Pro Markdown Styles */
      .prose h1, .prose h2, .prose h3 { color: #0f172a; margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; letter-spacing: -0.025em; }
      .prose p { margin-bottom: 0.8em; line-height: 1.6; color: #334155; }
      .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; color: #334155; }
      .prose strong { color: #0f172a; font-weight: 600; }
      .prose a { color: #0284c7; text-decoration: none; font-weight: 500; }
      .prose a:hover { text-decoration: underline; }
      
      @media (prefers-color-scheme: dark) {
        .prose h1, .prose h2, .prose h3 { color: #f8fafc; }
        .prose p { color: #cbd5e1; }
        .prose ul { color: #cbd5e1; }
        .prose strong { color: #fff; }
        .prose a { color: #38bdf8; }
      }

      /* Table Enhancements */
      .review-table th { position: sticky; top: 0; z-index: 10; font-weight: 600; letter-spacing: 0.05em; }
      .review-input { background: transparent; border: 1px solid transparent; width: 100%; padding: 6px 8px; border-radius: 6px; transition: all 0.2s; }
      .review-input:hover, .review-input:focus { outline: none; background: #fff; border-color: #cbd5e1; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
      @media (prefers-color-scheme: dark) {
        .review-input:hover, .review-input:focus { background: #1e293b; border-color: #475569; }
      }
      
      .mobile-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem; font-weight: 600; }
      @media (prefers-color-scheme: dark) { .mobile-label { color: #94a3b8; } }

      body { -webkit-overflow-scrolling: touch; }
    </style>
  </head>
  
  <body class="bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-200 font-sans min-h-screen lg:h-screen lg:overflow-hidden selection:bg-brand-100 dark:selection:bg-brand-900 selection:text-brand-900 dark:selection:text-brand-100">

    <div id="app" class="h-full flex flex-col lg:flex-row relative" v-cloak>
      
      <!-- TOASTS -->
      <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[250] flex flex-col gap-2 pointer-events-none w-full max-w-xs px-4">
        <transition-group name="fade">
          <div v-for="toast in toasts" :key="toast.id" 
               class="pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border min-w-0 w-full backdrop-blur-xl"
               :class="{
                 'bg-white/95 border-slate-200 text-slate-800 dark:bg-slate-800/95 dark:border-slate-700 dark:text-white': true
               }">
             <div class="w-2 h-2 rounded-full" :class="{
               'bg-emerald-500': toast.type === 'success',
               'bg-rose-500': toast.type === 'error',
               'bg-brand-500': toast.type === 'info'
             }"></div>
             <div class="text-sm font-medium truncate flex-1 text-center">{{ toast.message }}</div>
          </div>
        </transition-group>
      </div>

      <!-- MOBILE OVERLAY -->
      <transition name="fade">
        <div v-if="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 bg-slate-900/50 z-40 lg:hidden backdrop-blur-sm"></div>
      </transition>

      <!-- MOBILE FAB (Visible only on Project views) -->
      <button v-if="['active', 'dashboard'].includes(currentViewScope)" @click="showNewProjectModal = true" class="lg:hidden fixed bottom-6 right-6 z-50 w-14 h-14 bg-brand-600 hover:bg-brand-700 text-white rounded-full shadow-xl shadow-brand-600/30 flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
        <i data-lucide="plus" class="w-8 h-8"></i>
      </button>

      <!-- SIDEBAR -->
      <aside class="w-[85vw] sm:w-64 bg-white dark:bg-[#1e293b] border-r border-slate-200 dark:border-slate-800 flex flex-col justify-between shrink-0 transition-transform duration-300 z-50 fixed inset-y-0 left-0 lg:relative lg:translate-x-0 shadow-2xl lg:shadow-none" 
             :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'">
        <div>
          <!-- Brand -->
          <div class="h-16 lg:h-14 flex items-center px-6 lg:px-5 border-b border-slate-100 dark:border-slate-800 gap-3">
             <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-brand-700 flex items-center justify-center text-white font-bold text-xs shadow-md ring-1 ring-white/20">DT</div>
             <div><h1 class="font-bold text-sm text-slate-800 dark:text-slate-100 leading-tight tracking-tight">DT Groupe</h1><p class="text-[10px] text-slate-500 dark:text-slate-400 font-medium">Proxiserve - Prox-Hydro</p></div>
             <button @click="sidebarOpen = false" class="lg:hidden ml-auto p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-500 hover:text-slate-800 dark:hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
          </div>

          <!-- Navigation -->
          <nav class="p-4 lg:p-3 space-y-1">
            <div class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase px-3 py-2 tracking-wider">Pilotage</div>
            
            <button @click="currentViewScope = 'dashboard'; if(isMobile) sidebarOpen = false;" 
                    :class="currentViewScope === 'dashboard' 
                      ? 'bg-brand-50 text-brand-700 dark:bg-brand-600 dark:text-white font-semibold shadow-sm' 
                      : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'" 
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-all">
              <i data-lucide="layout-grid" class="w-5 h-5 lg:w-4 lg:h-4" :class="currentViewScope === 'dashboard' ? 'text-brand-600 dark:text-white' : 'text-slate-400'"></i> Tableau de Bord
            </button>

            <button @click="currentViewScope = 'active'; viewType = 'grid'; if(isMobile) sidebarOpen = false;" 
                    :class="currentViewScope === 'active' && viewType === 'grid' 
                      ? 'bg-brand-50 text-brand-700 dark:bg-brand-600 dark:text-white font-semibold shadow-sm' 
                      : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'" 
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-all">
              <i data-lucide="folder-kanban" class="w-5 h-5 lg:w-4 lg:h-4" :class="currentViewScope === 'active' && viewType === 'grid' ? 'text-brand-600 dark:text-white' : 'text-slate-400'"></i> Projets en cours
            </button>
            
            <button @click="currentViewScope = 'active'; viewType = 'review'; if(isMobile) sidebarOpen = false;" 
                    :class="viewType === 'review' 
                      ? 'bg-brand-50 text-brand-700 dark:bg-brand-600 dark:text-white font-semibold shadow-sm' 
                      : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'" 
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-all">
              <i data-lucide="presentation" class="w-5 h-5 lg:w-4 lg:h-4" :class="viewType === 'review' ? 'text-brand-600 dark:text-white' : 'text-slate-400'"></i> üéØ Revue de Projet
            </button>

            <div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800">
               <div class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase px-3 py-2 tracking-wider">Donn√©es</div>
               
               <button @click="currentViewScope = 'archived'; viewType = 'grid'; if(isMobile) sidebarOpen = false;" 
                    :class="currentViewScope === 'archived' 
                      ? 'bg-brand-50 text-brand-700 dark:bg-brand-600 dark:text-white font-semibold shadow-sm' 
                      : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'"
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-colors">
                 <i data-lucide="archive" class="w-5 h-5 lg:w-4 lg:h-4" :class="currentViewScope === 'archived' ? 'text-brand-600 dark:text-white' : 'text-slate-400'"></i> Archives
               </button>
               
               <button @click="currentViewScope = 'team'; if(isMobile) sidebarOpen = false;" 
                    :class="currentViewScope === 'team' 
                      ? 'bg-brand-50 text-brand-700 dark:bg-brand-600 dark:text-white font-semibold shadow-sm' 
                      : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'"
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-colors">
                 <i data-lucide="users" class="w-5 h-5 lg:w-4 lg:h-4" :class="currentViewScope === 'team' ? 'text-brand-600 dark:text-white' : 'text-slate-400'"></i> Annuaire √âquipe
               </button>
               
               <button @click="currentViewScope = 'kpi'; if(isMobile) sidebarOpen = false;" 
                    :class="currentViewScope === 'kpi' 
                      ? 'bg-brand-50 text-brand-700 dark:bg-brand-600 dark:text-white font-semibold shadow-sm' 
                      : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'"
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-colors">
                 <i data-lucide="pie-chart" class="w-5 h-5 lg:w-4 lg:h-4" :class="currentViewScope === 'kpi' ? 'text-brand-600 dark:text-white' : 'text-slate-400'"></i> Rapports KPI
               </button>
            </div>
          </nav>
        </div>

        <div class="border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-[#0f172a] p-4">
           <div class="p-2.5 flex items-center gap-3 bg-white dark:bg-[#1e293b] rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
              <img :src="currentUser.avatar" class="w-9 h-9 rounded-md border border-slate-200 dark:border-slate-600">
              <div class="flex-1 min-w-0"><p class="text-sm font-bold text-slate-800 dark:text-slate-200 truncate">{{ currentUser.name }}</p><p class="text-[10px] text-slate-500 truncate">{{ currentUser.email }}</p></div>
           </div>
           <button @click="showLegalModal = true" class="mt-3 text-[10px] text-center w-full text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">Mentions L√©gales & RGPD</button>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-[#0f172a] min-h-0">
        
        <!-- HEADER -->
        <header class="h-16 lg:h-16 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-4 sm:px-6 bg-white dark:bg-[#1e293b] sticky top-0 z-30 shrink-0 shadow-sm lg:shadow-none">
          <div class="flex items-center gap-3 sm:gap-4 flex-1 min-w-0">
            <button @click="sidebarOpen = !sidebarOpen" class="lg:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
            
            <h2 class="text-base sm:text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2 truncate tracking-tight">
               <span v-if="currentViewScope === 'dashboard'" class="text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 p-1.5 rounded-md"><i data-lucide="layout-grid" class="w-5 h-5"></i></span>
               <span v-else-if="currentViewScope === 'team'" class="text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 p-1.5 rounded-md"><i data-lucide="users" class="w-5 h-5"></i></span>
               <span v-else-if="currentViewScope === 'kpi'" class="text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 p-1.5 rounded-md"><i data-lucide="pie-chart" class="w-5 h-5"></i></span>
               <span v-else-if="viewType === 'review'" class="text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 p-1.5 rounded-md"><i data-lucide="presentation" class="w-5 h-5"></i></span>
               
               <span v-if="currentViewScope === 'dashboard'">Tableau de Bord</span>
               <span v-else-if="currentViewScope === 'team'">Annuaire √âquipe</span>
               <span v-else-if="currentViewScope === 'kpi'">Rapports KPI</span>
               <span v-else-if="viewType === 'review'">{{ isMobile ? 'Revue Mobile' : 'Cockpit Pilotage' }}</span>
               <span v-else>{{ currentViewScope === 'active' ? 'Projets' : 'Archives' }}</span>
            </h2>
            
            <div v-if="['active', 'archived'].includes(currentViewScope) && viewType !== 'review'" class="hidden sm:flex bg-slate-100 dark:bg-[#0f172a] rounded-lg p-1 ml-2 border border-slate-200 dark:border-slate-800">
               <button @click="viewType = 'grid'" :class="viewType === 'grid' ? 'bg-white text-brand-600 shadow-sm dark:bg-[#1e293b] dark:text-brand-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'" class="p-1.5 rounded-md transition-all"><i data-lucide="grid" class="w-4 h-4"></i></button>
               <button @click="viewType = 'list'" :class="viewType === 'list' ? 'bg-white text-brand-600 shadow-sm dark:bg-[#1e293b] dark:text-brand-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'" class="p-1.5 rounded-md transition-all"><i data-lucide="list" class="w-4 h-4"></i></button>
            </div>
          </div>

          <div class="flex items-center gap-2 sm:gap-3 shrink-0">
            
            <!-- Filter Toggle (Only for Projects List) -->
            <button v-if="currentViewScope === 'active' && viewType !== 'review'" @click="showCompleted = !showCompleted" 
              class="hidden md:flex items-center gap-2 px-3 py-2 rounded-lg border transition-all text-xs font-semibold shadow-sm"
              :class="showCompleted ? 'bg-brand-50 text-brand-700 border-brand-200 dark:bg-brand-900/20 dark:text-brand-300 dark:border-brand-800' : 'bg-white text-slate-600 border-slate-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-[#0f172a]'">
              <i :data-lucide="showCompleted ? 'eye' : 'eye-off'" class="w-4 h-4"></i>
              <span class="hidden lg:inline">{{ showCompleted ? 'Masquer termin√©s' : 'Voir termin√©s' }}</span>
            </button>

            <!-- User Filter (Only for Projects/Review) -->
            <div v-if="['active', 'archived', 'review'].includes(currentViewScope)" class="relative hidden lg:flex items-center bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 gap-2 shadow-sm">
               <i data-lucide="filter" class="w-3.5 h-3.5 text-slate-400"></i>
               <select v-model="selectedUserFilter" class="bg-transparent text-sm text-slate-700 dark:text-slate-300 outline-none cursor-pointer appearance-none pr-6 border-none py-0 w-full font-medium">
                  <option :value="null" class="bg-white dark:bg-[#1e1e1e]">Tous les membres</option>
                  <option v-for="user in teamMembers" :value="user.name" class="bg-white dark:bg-[#1e1e1e]">{{ user.name }}</option>
               </select>
               <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
            </div>

            <!-- Search (Only for Projects/Review/Team) -->
            <button v-if="currentViewScope !== 'dashboard' && currentViewScope !== 'kpi'" class="sm:hidden p-2 text-slate-500 dark:text-slate-400"><i data-lucide="search" class="w-5 h-5"></i></button>

            <div v-if="currentViewScope !== 'dashboard' && currentViewScope !== 'kpi'" class="relative hidden sm:block">
               <i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-slate-400"></i>
               <input type="text" placeholder="Rechercher..." v-model="searchQuery" class="bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-slate-200 text-sm rounded-lg pl-9 pr-4 py-2 focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 w-32 lg:w-56 placeholder-slate-400 transition-all shadow-sm">
            </div>

            <!-- BUTTONS: NEW PROJECT or ADD MEMBER -->
            <button v-if="['active', 'dashboard'].includes(currentViewScope)" @click="showNewProjectModal = true" class="hidden sm:flex bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all items-center gap-2 shadow-md shadow-brand-600/20 active:scale-95">
              <i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden lg:inline">Nouveau Projet</span>
              <span class="lg:hidden">Nouveau</span>
            </button>

            <button v-if="currentViewScope === 'team'" @click="openUserModal()" class="hidden sm:flex bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all items-center gap-2 shadow-md shadow-brand-600/20 active:scale-95">
              <i data-lucide="user-plus" class="w-4 h-4"></i> <span>Ajouter Membre</span>
            </button>
          </div>
        </header>

        <!-- MAIN SCROLL AREA -->
        <main ref="scrollContainer" class="flex-1 overflow-auto p-4 sm:p-8 relative lg:overflow-auto h-auto lg:h-full">
          
          <div v-if="loading" class="grid grid-cols-1 md:grid-cols-3 gap-6 p-2">
             <div v-for="i in 6" class="h-64 bg-slate-200 dark:bg-slate-800 rounded-xl animate-pulse-custom"></div>
          </div>

          <div v-else class="pb-20 lg:pb-0 max-w-7xl mx-auto"> 
            
            <!-- VIEW: DASHBOARD -->
            <div v-if="currentViewScope === 'dashboard'">
               <div class="flex flex-col gap-8">
                  <!-- ... Dashboard content same as before ... -->
                  <div class="flex items-end justify-between border-b border-slate-200 dark:border-slate-800 pb-6">
                     <div>
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Bonjour, {{ currentUser.name ? currentUser.name.split(' ')[0] : 'Invit√©' }} üëã</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-base">Voici la synth√®se de l'activit√©. <span class="hidden sm:inline">Vous avez <strong>{{ kpiData.tasksPending }} t√¢ches</strong> en cours.</span></p>
                     </div>
                     <div class="hidden sm:block text-right">
                        <div class="inline-flex items-center gap-3 bg-white dark:bg-[#1e293b] px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                           <div class="text-right">
                              <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Progression Globale</p>
                              <p class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">{{ kpiData.globalProgress }}%</p>
                           </div>
                           <div class="h-10 w-10 rounded-full border-4 border-slate-100 dark:border-slate-700 border-t-brand-500 animate-spin" style="animation-duration: 3s"></div>
                        </div>
                     </div>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                     <!-- ... Dashboard Widgets ... -->
                     <!-- COL 1 & 2: TOP PRIORITY PROJECTS -->
                     <div class="lg:col-span-2 space-y-5">
                        <div class="flex items-center gap-2 mb-2">
                           <div class="p-1.5 bg-rose-100 dark:bg-rose-900/30 rounded-md text-rose-600 dark:text-rose-400"><i data-lucide="flame" class="w-5 h-5"></i></div>
                           <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">Top 3 Priorit√©s</h3>
                        </div>
                        <div v-for="project in dashboardData.topProjects" :key="project.id" @click="openProjectDetails(project)" class="group bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700/60 hover:border-brand-400 dark:hover:border-brand-500 rounded-xl p-6 cursor-pointer transition-all hover:shadow-lg relative overflow-hidden">
                           <div class="absolute top-0 right-0 bg-slate-50 dark:bg-slate-800 text-slate-400 dark:text-slate-500 text-[10px] font-bold px-3 py-1 rounded-bl-xl border-l border-b border-slate-100 dark:border-slate-700/50">#{{ project.rank || '?' }}</div>
                           <div class="flex items-start gap-5">
                              <div class="text-4xl bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700">{{ project.emoji }}</div>
                              <div class="flex-1 min-w-0">
                                 <div class="flex items-center gap-2 mb-2">
                                    <span :class="getPriorityClass(project.priorite)" class="px-2.5 py-0.5 rounded-full text-[10px] border font-semibold">{{ project.priorite }}</span>
                                    <span class="px-2.5 py-0.5 rounded-full text-[10px] border bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-700 font-medium">{{ project.status }}</span>
                                 </div>
                                 <h4 class="text-xl font-bold text-slate-900 dark:text-white mb-1 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors">{{ project.nom }}</h4>
                                 <div class="flex items-center gap-6 text-sm text-slate-500 dark:text-slate-400 mt-2">
                                    <span class="flex items-center gap-1.5"><i data-lucide="user" class="w-3.5 h-3.5"></i> {{ project.owner }}</span>
                                    <span class="flex items-center gap-1.5"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> {{ formatDate(project.deadline) }}</span>
                                 </div>
                              </div>
                              <div class="hidden sm:block text-right self-center pl-4 border-l border-slate-100 dark:border-slate-700/50"><div class="text-3xl font-black text-slate-900 dark:text-white">{{ project.progress }}%</div></div>
                           </div>
                           <div class="mt-5 h-2 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-rose-500 to-amber-500" :style="{ width: project.progress + '%' }"></div></div>
                        </div>
                        <div v-if="dashboardData.topProjects.length === 0" class="text-center py-12 bg-white dark:bg-[#1e293b] rounded-xl border border-dashed border-slate-300 dark:border-slate-700 text-slate-500">Aucun projet prioritaire d√©tect√©. Commencez par en cr√©er un !</div>
                     </div>
                     <div class="space-y-6">
                        <div class="bg-white dark:bg-[#1e293b] rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                           <div class="bg-rose-50 dark:bg-rose-900/10 px-5 py-3 border-b border-rose-100 dark:border-rose-900/20 flex justify-between items-center"><h3 class="text-sm font-bold text-rose-700 dark:text-rose-400 flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i> Urgences ({{ dashboardData.allOverdue.length }})</h3></div>
                           <div class="divide-y divide-slate-100 dark:divide-slate-800 max-h-[350px] overflow-y-auto">
                              <div v-for="task in dashboardData.allOverdue" :key="task.id" class="p-4 hover:bg-slate-50 dark:hover:bg-[#252525] transition-colors cursor-pointer group" @click="openProjectDetails(projects.find(p=>p.id===task.project_id))">
                                 <div class="flex justify-between items-start mb-1.5"><span class="text-xs font-semibold text-slate-500 dark:text-slate-400 line-clamp-1 w-2/3 uppercase tracking-wide">{{ projects.find(p=>p.id===task.project_id)?.nom }}</span><span class="text-[10px] font-bold text-rose-600 bg-rose-100 dark:bg-rose-900/30 dark:text-rose-300 px-2 py-0.5 rounded-full">{{ formatDateShort(task.due_date) }}</span></div>
                                 <p class="text-sm text-slate-800 dark:text-slate-200 font-medium line-clamp-2 group-hover:text-rose-600 dark:group-hover:text-rose-400 transition-colors">{{ task.titre }}</p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            
            <!-- VIEW: TEAM (NEW) -->
            <div v-if="currentViewScope === 'team'" class="h-full flex flex-col">
               <div class="flex items-center justify-between mb-6">
                  <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Annuaire √âquipe</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">G√©rez les membres et leurs r√¥les.</p>
                  </div>
               </div>

               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  <div v-for="(user, index) in filteredTeam" :key="user.email" class="bg-white dark:bg-[#1e293b] rounded-xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-shadow relative group">
                     <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button @click="openUserModal(user)" class="p-1.5 text-slate-400 hover:text-brand-500 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button @click="deleteUser(index)" class="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                     </div>
                     <div class="flex items-center gap-4">
                        <img :src="user.avatar" class="w-16 h-16 rounded-full border-4 border-slate-50 dark:border-slate-800 bg-white dark:bg-slate-900">
                        <div>
                           <h3 class="font-bold text-slate-900 dark:text-white text-lg">{{ user.name }}</h3>
                           <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">{{ user.email }}</p>
                           <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border" 
                                 :class="user.role === 'Admin' ? 'bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800' : 
                                         (user.role === 'Manager' ? 'bg-brand-100 text-brand-800 border-brand-200 dark:bg-brand-900/30 dark:text-brand-300 dark:border-brand-800' : 
                                         'bg-slate-100 text-slate-800 border-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700')">
                              {{ user.role }}
                           </span>
                        </div>
                     </div>
                  </div>
                  
                  <!-- Add User Card -->
                  <div @click="openUserModal()" class="bg-slate-50 dark:bg-[#1e293b]/50 rounded-xl p-5 border-2 border-dashed border-slate-300 dark:border-slate-700 flex flex-col items-center justify-center text-slate-400 dark:text-slate-500 cursor-pointer hover:border-brand-400 hover:text-brand-500 dark:hover:border-brand-500 transition-colors min-h-[140px]">
                     <div class="w-12 h-12 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center mb-3 shadow-sm"><i data-lucide="plus" class="w-6 h-6"></i></div>
                     <span class="font-medium">Ajouter un membre</span>
                  </div>
               </div>
            </div>

            <!-- VIEW: KPI (NEW) -->
            <div v-if="currentViewScope === 'kpi'" class="h-full flex flex-col">
                <div class="flex items-center justify-between mb-8">
                  <div>
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white">Rapports & KPI</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Analyse de la performance et de la charge.</p>
                  </div>
               </div>

               <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                  <div class="bg-white dark:bg-[#1e293b] p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group">
                     <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="folder" class="w-16 h-16 text-slate-900 dark:text-white"></i></div>
                     <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Projets Actifs</p>
                     <p class="text-4xl font-black text-slate-900 dark:text-white mt-2">{{ kpiData.activeProjects }}</p>
                  </div>
                  <div class="bg-white dark:bg-[#1e293b] p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group">
                     <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="clock" class="w-16 h-16 text-amber-500"></i></div>
                     <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">T√¢ches en cours</p>
                     <p class="text-4xl font-black text-amber-600 dark:text-amber-500 mt-2">{{ kpiData.tasksPending }}</p>
                  </div>
                  <div class="bg-white dark:bg-[#1e293b] p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group">
                     <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="check-circle" class="w-16 h-16 text-emerald-500"></i></div>
                     <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">T√¢ches Termin√©es</p>
                     <p class="text-4xl font-black text-emerald-600 dark:text-emerald-500 mt-2">{{ kpiData.tasksDone }}</p>
                  </div>
                  <div class="bg-white dark:bg-[#1e293b] p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group">
                     <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="trending-up" class="w-16 h-16 text-brand-500"></i></div>
                     <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Avancement Global</p>
                     <p class="text-4xl font-black text-brand-600 dark:text-brand-500 mt-2">{{ kpiData.globalProgress }}%</p>
                  </div>
               </div>

               <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                  <!-- Workload Chart -->
                  <div class="bg-white dark:bg-[#1e293b] p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                     <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6">Charge de travail par personne</h3>
                     <div class="space-y-5">
                        <div v-for="user in kpiData.userStats" :key="user.name" class="flex items-center gap-4">
                           <img :src="getUserAvatar(user.name)" class="w-10 h-10 rounded-full border-2 border-slate-100 dark:border-slate-700">
                           <div class="flex-1">
                              <div class="flex justify-between text-sm mb-2">
                                 <span class="font-medium text-slate-700 dark:text-slate-200">{{ user.name }}</span>
                                 <span class="font-mono text-slate-500">{{ user.count }} t√¢ches</span>
                              </div>
                              <div class="h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                 <div class="h-full bg-brand-500 rounded-full transition-all duration-1000" :style="{ width: (user.count / kpiData.maxTasks * 100) + '%' }"></div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>

                  <!-- Project Health Chart -->
                  <div class="bg-white dark:bg-[#1e293b] p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                     <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6">Sant√© des Projets (Top 5)</h3>
                     <div class="space-y-4">
                        <div v-for="p in kpiData.topProjects" :key="p.id" class="p-4 bg-slate-50 dark:bg-[#252525] rounded-lg border border-slate-100 dark:border-slate-700/50">
                           <div class="flex justify-between items-center mb-2">
                              <span class="font-semibold text-slate-800 dark:text-slate-200 truncate pr-4">{{ p.emoji }} {{ p.nom }}</span>
                              <span class="text-xs font-bold px-2 py-1 rounded bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300">{{ p.progress }}%</span>
                           </div>
                           <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                              <div class="h-full rounded-full transition-all duration-1000" :class="p.progress === 100 ? 'bg-emerald-500' : 'bg-gradient-to-r from-brand-500 to-indigo-500'" :style="{ width: p.progress + '%' }"></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- VIEW: REVIEW & GRID (EXISTING - RETAINED FOR CONTEXT) -->
            <div v-if="viewType === 'review' && currentViewScope !== 'dashboard' && currentViewScope !== 'team' && currentViewScope !== 'kpi'" class="h-full flex flex-col">
               <!-- ... (Existing Review Code) ... -->
               <div class="hidden sm:flex items-start gap-4 mb-6 p-5 bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm">
                  <div class="p-3 bg-brand-100 dark:bg-brand-500/20 rounded-xl shrink-0"><i data-lucide="sliders" class="w-6 h-6 text-brand-600 dark:text-brand-400"></i></div>
                  <div>
                     <h3 class="text-slate-900 dark:text-white font-bold text-lg">R√©union de Pilotage</h3>
                     <p class="text-sm text-slate-500 dark:text-slate-400 max-w-2xl mt-1">
                        Utilisez les poign√©es <i data-lucide="grip-vertical" class="w-3 h-3 inline"></i> pour d√©finir l'ordre de priorit√© global. <br>
                        Les modifications sont r√©percut√©es instantan√©ment sur tous les affichages.
                     </p>
                     <button @click="exportToCSV" class="mt-3 text-xs flex items-center gap-1.5 text-brand-600 dark:text-brand-400 hover:underline font-medium bg-brand-50 dark:bg-brand-900/20 px-3 py-1.5 rounded-full w-fit"><i data-lucide="download" class="w-3 h-3"></i> Exporter le compte-rendu (CSV)</button>
                  </div>
               </div>
               <!-- ... (Rest of Review View - Tables/Cards) ... -->
               <div class="sm:hidden mb-4 px-1 flex justify-between items-center"><p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Glissez pour prioriser <i data-lucide="arrow-down-up" class="w-3 h-3 inline ml-1"></i></p><button @click="exportToCSV" class="text-xs text-brand-600"><i data-lucide="download" class="w-4 h-4"></i></button></div>
               <div class="hidden sm:block bg-white dark:bg-[#1e293b] rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden flex-1 overflow-y-auto shadow-sm">
                  <table class="w-full text-left text-sm review-table">
                     <thead class="bg-slate-50 dark:bg-[#0f172a] text-slate-500 dark:text-slate-400 font-semibold text-xs uppercase tracking-wider border-b border-slate-200 dark:border-slate-700"><tr><th class="px-4 py-3 w-12 text-center bg-slate-50 dark:bg-[#0f172a]"></th><th class="px-4 py-3 min-w-[280px] bg-slate-50 dark:bg-[#0f172a]">Projet</th><th class="px-4 py-3 w-40 bg-slate-50 dark:bg-[#0f172a]">Propri√©taire</th><th class="px-4 py-3 w-36 bg-slate-50 dark:bg-[#0f172a]">Deadline</th><th class="px-4 py-3 w-32 bg-slate-50 dark:bg-[#0f172a]">Priorit√©</th><th class="px-4 py-3 w-32 bg-slate-50 dark:bg-[#0f172a]">Statut</th><th class="px-4 py-3 min-w-[250px] bg-slate-50 dark:bg-[#0f172a]">D√©cision S√©ance</th></tr></thead>
                     <tbody :ref="el => { if(el) initProjectSortable(el) }" class="divide-y divide-slate-100 dark:divide-slate-800">
                        <tr v-for="(project, index) in filteredProjects" :key="project.id" :data-id="project.id" class="hover:bg-slate-50 dark:hover:bg-[#252525] group transition-colors">
                           <td class="px-4 py-3 text-center align-top pt-4"><div class="project-drag-handle w-8 h-8 mx-auto flex items-center justify-center rounded cursor-move hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"><i data-lucide="grip-vertical" class="w-4 h-4 text-slate-400 dark:text-slate-500"></i></div></td>
                           <td class="px-4 py-3 align-top"><div class="flex items-center gap-3 mb-1"><button @click="openProjectDetails(project)" class="p-1 hover:bg-brand-100 dark:hover:bg-brand-500/20 rounded text-brand-600 dark:text-brand-400 transition-colors"><i data-lucide="maximize-2" class="w-4 h-4"></i></button><span class="text-xl">{{ project.emoji }}</span><input v-model="project.nom" @change="updateProject(project)" class="review-input font-bold text-slate-900 dark:text-white text-sm" /><i v-if="hasDateConflict(project)" data-lucide="alert-triangle" class="w-4 h-4 text-amber-500"></i></div><div class="pl-8 opacity-80 transition-opacity"><input v-model="project.description" @change="updateProject(project)" class="review-input text-xs text-slate-500 dark:text-slate-400 italic" placeholder="Description..." /></div></td>
                           <td class="px-4 py-3 align-top"><select v-model="project.owner" @change="updateProject(project)" class="review-input bg-transparent text-slate-700 dark:text-slate-300 text-xs py-1"><option v-for="user in teamMembers" :value="user.name" class="bg-white dark:bg-[#1e1e1e]">{{ user.name }}</option></select></td>
                           <td class="px-4 py-3 align-top"><input type="date" :value="toInputDate(project.deadline)" @input="e => { project.deadline = new Date(e.target.value); updateProject(project); }" class="review-input text-xs font-mono py-1" :class="isOverdueProject(project) ? 'text-rose-600 dark:text-rose-400 font-bold border-rose-200 dark:border-rose-900/50 bg-rose-50 dark:bg-rose-900/10' : 'text-slate-500 dark:text-slate-400'"></td>
                           <td class="px-4 py-3 align-top"><select v-model="project.priorite" @change="updateProject(project)" class="review-input text-xs font-bold py-1 border" :class="{'text-rose-600 border-rose-200 bg-rose-50 dark:text-rose-400 dark:border-rose-900/50 dark:bg-rose-900/10': project.priorite === 'Haute', 'text-amber-600 border-amber-200 bg-amber-50 dark:text-amber-400 dark:border-amber-900/50 dark:bg-amber-900/10': project.priorite === 'Moyenne', 'text-brand-600 border-brand-200 bg-brand-50 dark:text-brand-400 dark:border-brand-900/50 dark:bg-brand-900/10': project.priorite === 'Basse'}"><option value="Haute" class="bg-white dark:bg-[#202020]">üî• Haute</option><option value="Moyenne" class="bg-white dark:bg-[#202020]">‚ö° Moyenne</option><option value="Basse" class="bg-white dark:bg-[#202020]">‚òï Basse</option></select></td>
                           <td class="px-4 py-3 align-top"><select v-model="project.status" @change="updateProject(project)" class="review-input text-xs font-medium py-1 rounded-full text-center" :class="{'text-emerald-700 bg-emerald-50 dark:text-emerald-400 dark:bg-emerald-900/20': project.status === 'Termin√©', 'text-amber-700 bg-amber-50 dark:text-amber-400 dark:bg-amber-900/20': project.status === 'En cours', 'text-slate-500 bg-slate-100 dark:text-slate-400 dark:bg-slate-700/20': project.status === 'En pause', 'text-rose-700 bg-rose-50 dark:text-rose-400 dark:bg-rose-900/20': project.status === 'Annul√©'}"><option value="En cours" class="bg-white dark:bg-[#202020]">En cours</option><option value="Termin√©" class="bg-white dark:bg-[#202020]">Termin√©</option><option value="En pause" class="bg-white dark:bg-[#202020]">En pause</option><option value="Annul√©" class="bg-white dark:bg-[#202020]">Annul√©</option></select></td>
                           <td class="px-4 py-3 align-top"><textarea v-model="project.meeting_notes" @change="updateProject(project)" placeholder="Note de d√©cision..." rows="1" class="review-input text-xs text-brand-700 dark:text-brand-200 bg-brand-50 dark:bg-brand-900/10 border-brand-100 dark:border-brand-900/20 placeholder-brand-300 dark:placeholder-brand-500/50 resize-none focus:h-20 focus:absolute focus:z-20 focus:w-64 focus:shadow-xl"></textarea></td>
                        </tr>
                     </tbody>
                  </table>
               </div>
               <!-- ... Mobile Review Cards ... -->
               <div class="sm:hidden space-y-4" :ref="el => { if(el) initProjectSortable(el) }">
                  <div v-for="(project, index) in filteredProjects" :key="project.id" :data-id="project.id" class="bg-white dark:bg-[#1e293b] rounded-xl p-4 border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden">
                     <!-- ... (Mobile Card Content) ... -->
                     <div class="flex items-start justify-between mb-4"><div class="flex items-center gap-3"><div class="text-3xl">{{ project.emoji }}</div><div class="flex-1"><button @click="openProjectDetails(project)" class="font-bold text-slate-900 dark:text-white text-lg text-left leading-tight active:text-brand-500 transition-colors flex items-center gap-2">{{ project.nom }}<i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i></button></div></div><div class="project-drag-handle p-3 -mr-2 text-slate-400"><i data-lucide="grip-vertical" class="w-7 h-7"></i></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><div class="mobile-label">Priorit√©</div><select v-model="project.priorite" @change="updateProject(project)" class="w-full bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-white text-base sm:text-sm rounded-lg p-2 border border-slate-200 dark:border-slate-700 h-12 sm:h-10"><option value="Haute">üî• Haute</option><option value="Moyenne">‚ö° Moyenne</option><option value="Basse">‚òï Basse</option></select></div><div><div class="mobile-label">Statut</div><select v-model="project.status" @change="updateProject(project)" class="w-full bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-white text-base sm:text-sm rounded-lg p-2 border border-slate-200 dark:border-slate-700 h-12 sm:h-10"><option value="En cours">En cours</option><option value="Termin√©">Termin√©</option><option value="En pause">En pause</option><option value="Annul√©">Annul√©</option></select></div></div><div class="mb-4"><div class="mobile-label">Deadline</div><input type="date" :value="toInputDate(project.deadline)" @input="e => { project.deadline = new Date(e.target.value); updateProject(project); }" class="w-full bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-white text-base sm:text-sm rounded-lg p-2 border border-slate-200 dark:border-slate-700 h-12 sm:h-10"></div><div><div class="mobile-label">Notes D√©cision</div><textarea v-model="project.meeting_notes" @change="updateProject(project)" placeholder="Notes de s√©ance..." rows="2" class="w-full bg-brand-50 dark:bg-brand-900/20 text-brand-900 dark:text-brand-200 text-base sm:text-sm rounded-lg p-3 border border-brand-100 dark:border-brand-900/30 resize-none"></textarea></div>
                  </div>
               </div>
            </div>

            <!-- VIEW: GRID & LIST (Standard Project Views) -->
            <div v-if="viewType === 'grid' && currentViewScope !== 'dashboard' && currentViewScope !== 'team' && currentViewScope !== 'kpi'" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 sm:gap-8">
              <!-- ... (Existing Grid Content) ... -->
               <div v-for="project in filteredProjects" :key="project.id" :data-id="project.id" @click="openProjectDetails(project)" class="group bg-white dark:bg-[#1e293b] border-l-4 border-y border-r border-slate-200 dark:border-slate-800 hover:border-r-brand-300 dark:hover:border-r-brand-600 rounded-xl p-6 cursor-pointer transition-all hover:shadow-lg relative overflow-hidden flex flex-col h-auto min-h-[18rem] active:scale-[0.99]" :class="{'border-l-emerald-500': project.status === 'Termin√©', 'border-l-amber-500': project.status === 'En cours', 'border-l-slate-400': project.status === 'En pause', 'border-l-rose-500': project.status === 'Annul√©'}"> <div class="flex justify-between items-start mb-4"><div class="w-14 h-14 rounded-xl bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-3xl shadow-inner border border-slate-100 dark:border-slate-700">{{ project.emoji || 'üìÅ' }}</div><div class="flex items-center gap-2"><span :class="getPriorityClass(project.priorite)" class="text-[10px] uppercase font-bold px-2 py-1 rounded-md border shadow-sm">{{ project.priorite }}</span><span :class="getProjectStatusClass(project.status)" class="px-2 py-1 rounded-md text-[10px] font-medium border shadow-sm">{{ project.status }}</span><button @click.stop="openProjectDetails(project)" class="p-1 text-slate-400 hover:text-brand-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors ml-1" title="Ouvrir la fiche"><i data-lucide="maximize-2" class="w-4 h-4"></i></button></div></div><div class="mb-2"><h3 class="text-slate-900 dark:text-white font-bold text-lg leading-tight group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors flex items-center gap-2">{{ project.nom }}<i v-if="hasDateConflict(project)" data-lucide="alert-triangle" class="w-4 h-4 text-amber-500"></i></h3><div class="flex items-center gap-2 mt-1.5"><span :class="getPriorityClass(project.priorite)" class="text-[10px] font-bold px-1.5 py-0.5 rounded border flex items-center gap-1"><i data-lucide="flag" class="w-3 h-3"></i> {{ project.priorite }}</span></div></div><div class="flex flex-wrap gap-1 mt-2 mb-4"><span v-for="tag in project.tags" :key="tag" class="px-2 py-0.5 bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-300 text-[10px] rounded-full border border-brand-100 dark:border-brand-900/30 font-medium">{{ tag }}</span></div><div class="flex items-center gap-2 mb-5 pb-4 border-b border-slate-100 dark:border-slate-800"><img :src="getUserAvatar(project.owner)" class="w-6 h-6 rounded-full border border-slate-100 dark:border-slate-600 shadow-sm"><p class="text-xs text-slate-600 dark:text-slate-400 font-semibold">{{ project.owner }}</p></div><div class="text-xs text-slate-500 dark:text-slate-400 mb-4 line-clamp-3 leading-relaxed opacity-90 flex-1" v-html="stripMarkdown(project.description) || 'Aucune description...'"></div><div class="mt-auto"><div class="flex justify-between text-[10px] text-slate-400 mb-1.5 font-bold uppercase tracking-wide"><span>Avancement</span><span>{{ project.progress }}%</span></div><div class="h-2 w-full bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-brand-500 to-indigo-600 transition-all duration-500" :style="{ width: project.progress + '%' }"></div></div></div></div>
              <div @click="showNewProjectModal = true" class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-5 flex flex-col items-center justify-center text-slate-400 dark:text-slate-500 hover:border-brand-400 dark:hover:border-brand-500 hover:text-brand-500 dark:hover:text-brand-400 hover:bg-brand-50/50 dark:hover:bg-[#1e293b] cursor-pointer transition-all min-h-[18rem]"><div class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform"><i data-lucide="plus" class="w-8 h-8 text-slate-400"></i></div><span class="text-sm font-bold">Cr√©er un projet</span></div>
            </div>

            <div v-if="viewType === 'list' && currentViewScope !== 'dashboard' && currentViewScope !== 'team' && currentViewScope !== 'kpi'" class="bg-white dark:bg-[#1e293b] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
               <!-- ... (Existing List View) ... -->
               <div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 dark:bg-[#252525] text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700 font-medium text-xs uppercase tracking-wider"><tr><th class="px-6 py-4 w-12"></th><th class="px-6 py-4">Nom du projet</th><th class="px-6 py-4">√âtat</th><th class="px-6 py-4">Propri√©taire</th><th class="px-6 py-4">Priorit√©</th><th class="px-6 py-4">Progression</th><th class="px-6 py-4 text-right">Deadline</th></tr></thead><tbody class="divide-y divide-slate-200 dark:divide-slate-800"><tr v-for="project in filteredProjects" :key="project.id" :data-id="project.id" @click="openProjectDetails(project)" class="hover:bg-slate-50 dark:hover:bg-[#252525] cursor-pointer transition-colors group"><td class="pl-6 py-4 text-2xl">{{ project.emoji || 'üìÅ' }}</td><td class="px-6 py-4 font-bold text-slate-900 dark:text-white group-hover:text-brand-600 dark:group-hover:text-brand-400">{{ project.nom }} <i v-if="hasDateConflict(project)" data-lucide="alert-triangle" class="inline w-3 h-3 text-orange-500 ml-1"></i></td><td class="px-6 py-4"><span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border" :class="getProjectStatusClass(project.status)">{{ project.status }}</span></td><td class="px-6 py-4 text-slate-600 dark:text-slate-300 flex items-center gap-2"><img :src="getUserAvatar(project.owner)" class="w-6 h-6 rounded-full border border-slate-200 dark:border-slate-600">{{ project.owner }}</td><td class="px-6 py-4"><span :class="getPriorityClass(project.priorite)" class="px-2.5 py-1 rounded-md border text-[10px] font-bold tracking-wide shadow-sm">{{ project.priorite }}</span></td><td class="px-6 py-4 w-48"><div class="flex items-center gap-3"><span class="text-xs font-mono text-slate-500 dark:text-slate-400 w-8 text-right">{{ project.progress }}%</span><div class="h-2 flex-1 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-brand-500" :style="{ width: project.progress + '%' }"></div></div></div></td><td class="px-6 py-4 text-right text-slate-500 dark:text-slate-400 text-xs font-mono">{{ formatDate(project.deadline) }}</td></tr></tbody></table></div>
               <div class="sm:hidden space-y-3 p-4"><div v-for="project in filteredProjects" :key="project.id" @click="openProjectDetails(project)" class="bg-white dark:bg-[#1e293b] rounded-xl p-4 border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-4 active:scale-[0.98] transition-transform"><div class="text-3xl shrink-0">{{ project.emoji || 'üìÅ' }}</div><div class="flex-1 min-w-0"><h4 class="font-bold text-slate-900 dark:text-white truncate">{{ project.nom }}</h4><div class="flex items-center gap-2 text-xs text-slate-500 mt-1"><span class="px-2 py-0.5 rounded border" :class="getProjectStatusClass(project.status)">{{ project.status }}</span><span>‚Ä¢</span><span :class="{'text-rose-500 font-bold': isOverdueProject(project)}">{{ formatDateShort(project.deadline) }}</span></div></div><div class="shrink-0 flex flex-col items-end gap-1"><span :class="getPriorityClass(project.priorite)" class="px-2 py-0.5 rounded text-[10px] border">{{ project.priorite }}</span><span class="text-xs font-mono text-slate-400">{{ project.progress }}%</span></div></div></div>
            </div>

          </div>
        </main>
      </div>

      <!-- MODALS (DETAILS, NEW PROJECT, TEAM, KPI, LEGAL) - SAME AS PREVIOUS, ADDING USER MODAL -->
      <!-- ... (Project Details Modal Code kept as is from context) ... -->
      <transition name="fade"><div v-if="activeProject" class="fixed inset-0 bg-black/60 backdrop-blur-[2px] z-[200] flex justify-center items-center p-0 sm:p-4 sm:justify-end" @click.self="activeProject = null"><div class="w-full h-full sm:h-full sm:max-w-3xl bg-white dark:bg-[#1e293b] border-l border-slate-200 dark:border-slate-700 shadow-2xl flex flex-col transform transition-transform duration-300"><div class="h-14 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center px-4 bg-slate-50 dark:bg-[#0f172a] shrink-0"><div class="flex gap-2 text-slate-500 dark:text-slate-400 text-xs items-center truncate"><button @click="activeProject = null" class="flex items-center gap-1 hover:text-slate-900 dark:hover:text-white"><i data-lucide="chevron-left" class="w-4 h-4"></i> Retour</button></div><button @click="activeProject = null" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex-1 overflow-y-auto p-5 sm:p-8 sm:px-12 bg-slate-50 dark:bg-[#0f172a]"><!-- ... Project Details Content ... --> <div class="mb-8"><div class="text-6xl mb-4 text-center sm:text-left">{{ activeProject.emoji || 'üìÅ' }}</div><h1 class="text-2xl sm:text-4xl font-black text-slate-900 dark:text-white mb-6 leading-tight text-center sm:text-left">{{ activeProject.nom }}</h1><div class="flex flex-wrap items-center gap-3 mb-8 justify-center sm:justify-start"><div class="relative group"><select v-model="activeProject.status" @change="updateProject(activeProject)" class="appearance-none pl-4 pr-10 py-2 rounded-full font-bold text-sm cursor-pointer transition-all shadow-sm focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#f8fafc] dark:focus:ring-offset-[#1e293b]" :class="getProjectStatusClass(activeProject.status)"><option value="En cours" class="bg-white dark:bg-[#1e293b] text-slate-900 dark:text-white">En cours</option><option value="Termin√©" class="bg-white dark:bg-[#1e293b] text-slate-900 dark:text-white">Termin√©</option><option value="En pause" class="bg-white dark:bg-[#1e293b] text-slate-900 dark:text-white">En pause</option><option value="Annul√©" class="bg-white dark:bg-[#1e293b] text-slate-900 dark:text-white">Annul√©</option></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 opacity-50 pointer-events-none group-hover:opacity-80"></i></div><div class="relative group"><select v-model="activeProject.priorite" @change="updateProject(activeProject)" class="appearance-none px-3 py-2 rounded-full text-xs font-bold border flex items-center gap-1.5 shadow-sm cursor-pointer pr-8" :class="getPriorityClass(activeProject.priorite)"><option value="Haute" class="bg-white dark:bg-[#1e293b] text-slate-900 dark:text-white">üî• Haute</option><option value="Moyenne" class="bg-white dark:bg-[#1e293b] text-slate-900 dark:text-white">‚ö° Moyenne</option><option value="Basse" class="bg-white dark:bg-[#1e293b] text-slate-900 dark:text-white">‚òï Basse</option></select><i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 opacity-50 pointer-events-none"></i></div><button @click="openProjectDetails(activeProject)" class="hidden sm:flex items-center justify-center p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 hover:text-brand-600 transition-colors" title="Rafra√Æchir / Ouvrir"><i data-lucide="maximize-2" class="w-4 h-4"></i></button></div><div class="mb-6 flex flex-wrap gap-2 justify-center sm:justify-start"><span v-for="(tag, i) in activeProject.tags" :key="i" class="px-3 py-1 bg-brand-100 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 text-xs rounded-full border border-brand-200 dark:border-brand-800 flex items-center gap-1">{{ tag }} <button @click="removeTag(activeProject, i)" class="hover:text-brand-900 dark:hover:text-white"><i data-lucide="x" class="w-3 h-3"></i></button></span><input @keyup.enter="addTag(activeProject, $event)" placeholder="+ Tag" class="px-3 py-1 bg-slate-100 dark:bg-[#2c2c2c] text-xs rounded-full border-none outline-none w-20 focus:w-32 transition-all text-slate-900 dark:text-white placeholder-slate-400"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm bg-white dark:bg-[#1e293b] p-4 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm"><div class="flex items-center justify-between sm:justify-start gap-2 border-b sm:border-b-0 border-slate-100 dark:border-slate-800 pb-2 sm:pb-0"><span class="text-slate-400 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> Owner</span><span class="font-medium text-slate-900 dark:text-white flex items-center gap-2"><img :src="getUserAvatar(activeProject.owner)" class="w-5 h-5 rounded-full"> {{ activeProject.owner }}</span></div><div class="flex items-center justify-between sm:justify-start gap-2 border-b sm:border-b-0 border-slate-100 dark:border-slate-800 pb-2 sm:pb-0"><span class="text-slate-400 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i> Fin</span><span class="font-mono text-slate-900 dark:text-white">{{ formatDate(activeProject.deadline) }}</span></div></div></div><div class="mb-10"><div class="flex justify-between items-center mb-3"><h3 class="text-lg font-bold text-slate-900 dark:text-white">Contexte</h3><button @click="toggleEditDesc" class="text-xs text-brand-600 dark:text-brand-400 font-medium hover:underline">{{ isEditingDesc ? 'Terminer' : 'Modifier' }}</button></div><div class="bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-[#333] rounded-xl p-5 text-slate-700 dark:text-slate-300 min-h-[100px] shadow-sm"><div v-if="!isEditingDesc" @dblclick="isEditingDesc = true" class="prose prose-invert prose-sm max-w-none" v-html="renderMarkdown(activeProject.description) || '<p class=\'text-slate-400 italic\'>Aucune description. Double-cliquez pour ajouter du contenu...</p>'"></div><textarea v-else ref="descInput" v-model="activeProject.description" class="w-full bg-transparent border-none outline-none resize-none text-base sm:text-sm leading-relaxed h-full min-h-[150px] text-slate-900 dark:text-slate-200" @blur="isEditingDesc = false"></textarea></div></div><div class="border-t border-slate-200 dark:border-slate-800 pt-8 pb-10"><div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-slate-900 dark:text-white">T√¢ches</h3><span class="bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs px-2 py-1 rounded-full">{{ getTasksByProject(activeProject.id).length }}</span></div><div class="flex flex-col sm:flex-row gap-3 mb-6"><div class="flex gap-2 flex-1 bg-white dark:bg-[#1e293b] p-1 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm"><button @click="addTask" class="bg-brand-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shrink-0"><i data-lucide="plus" class="w-5 h-5"></i></button><input ref="taskInputRef" v-model="newTaskTitle" @keyup.enter="addTask" type="text" placeholder="Nouvelle t√¢che..." class="flex-1 bg-transparent text-base sm:text-sm px-2 outline-none text-slate-900 dark:text-white placeholder-slate-400"></div><div class="flex gap-2"><input type="date" v-model="newTaskDate" class="flex-1 bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 rounded-lg text-xs text-slate-700 dark:text-slate-300 outline-none px-3 h-12 sm:h-auto font-mono"><select v-model="newTaskAssignee" class="flex-1 bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 rounded-lg text-xs text-slate-700 dark:text-slate-300 outline-none px-3 h-12 sm:h-auto"><option v-for="user in teamMembers" :value="user.name">{{ user.name }}</option></select></div></div><div class="space-y-8"><div v-for="status in ['√Ä faire', 'En cours', 'Termin√©']" :key="status"><div class="flex items-center gap-3 mb-3 select-none"><span class="px-2.5 py-1 rounded-md text-xs font-bold tracking-wide uppercase" :class="getStatusColor(status)">{{ status }}</span><div class="h-[1px] bg-slate-200 dark:bg-slate-800 flex-1"></div></div><div :ref="el => { if(el) initSortable(el, status) }" class="space-y-2 min-h-[20px]" :data-status="status"><div v-for="task in getTasksByStatus(status)" :key="task.id" :data-id="task.id" class="drag-handle bg-white dark:bg-[#1e293b] p-3 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm flex items-start gap-3 active:scale-[0.98] transition-transform"><button @click.stop="cycleStatus(task)" class="mt-0.5 w-6 h-6 sm:w-5 sm:h-5 rounded-full border-2 flex items-center justify-center shrink-0" :class="task.status === 'Termin√©' ? 'bg-brand-500 border-brand-500' : 'border-slate-300 dark:border-slate-600'"><i v-if="task.status === 'Termin√©'" data-lucide="check" class="w-4 h-4 text-white"></i></button><div class="flex-1 min-w-0" @click="startEdit(task)"><p class="text-base sm:text-sm font-medium truncate" :class="task.status === 'Termin√©' ? 'text-slate-400 line-through' : 'text-slate-900 dark:text-slate-100'">{{ task.titre }}</p><div class="flex items-center gap-3 mt-1.5"><div v-if="task.due_date" class="flex items-center gap-1 text-[10px] font-mono" :class="isOverdue(task) ? 'text-rose-500 font-bold' : 'text-slate-400'"><i data-lucide="calendar" class="w-3 h-3"></i> {{ formatDateShort(task.due_date) }}</div><div class="flex items-center gap-1.5"><img :src="getUserAvatar(task.assignee)" class="w-4 h-4 rounded-full"> <span class="text-[10px] text-slate-500">{{ task.assignee }}</span></div></div></div><button @click.stop="deleteTask(task)" class="text-slate-400 hover:text-rose-500 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div></div></div></div></div></div></div></transition>
      <div v-if="showNewProjectModal" class="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[200] backdrop-blur-sm px-4"><div class="bg-white dark:bg-[#1e293b] w-full max-w-md p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-2xl"><h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-2"><div class="w-8 h-8 rounded bg-brand-100 dark:bg-brand-900/30 flex items-center justify-center text-brand-600 dark:text-brand-400"><i data-lucide="plus" class="w-5 h-5"></i></div> Nouveau Projet</h2><div class="space-y-4"><div class="flex gap-3"><div class="w-16"><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Emoji</label><input v-model="newProjectForm.emoji" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-center text-xl outline-none focus:border-brand-500 text-slate-900 dark:text-white h-12 sm:h-10" placeholder="üìÅ"></div><div class="flex-1"><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Nom du projet</label><input v-model="newProjectForm.nom" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white focus:border-brand-500 outline-none transition-colors h-12 sm:h-10 text-base sm:text-sm" placeholder="Ex: D√©ploiement Salesforce"></div></div><div><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Deadline</label><input type="date" v-model="newProjectForm.deadline_str" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white outline-none h-12 sm:h-10 font-mono"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Propri√©taire</label><select v-model="newProjectForm.owner" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white outline-none appearance-none h-12 sm:h-10 text-base sm:text-sm"><option v-for="user in teamMembers" :value="user.name" class="bg-white dark:bg-[#1e1e1e]">{{ user.name }}</option></select></div><div><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Priorit√©</label><select v-model="newProjectForm.priorite" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white outline-none appearance-none h-12 sm:h-10 text-base sm:text-sm"><option value="Haute" class="bg-white dark:bg-[#1e1e1e]">üî• Haute</option><option value="Moyenne" class="bg-white dark:bg-[#1e1e1e]">‚ö° Moyenne</option><option value="Basse" class="bg-white dark:bg-[#1e1e1e]">‚òï Basse</option></select></div></div><div><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Description</label><textarea v-model="newProjectForm.description" rows="3" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white outline-none resize-none text-base sm:text-sm" placeholder="Contexte du projet..."></textarea></div></div><div class="flex justify-end gap-3 mt-8"><button @click="showNewProjectModal = false" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white px-4 py-2 text-sm font-medium">Annuler</button><button @click="createProject" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-brand-600/10 transition-all active:scale-95">Cr√©er le projet</button></div></div></div>

      <!-- NEW: USER EDIT MODAL -->
      <div v-if="showUserModal" class="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[200] backdrop-blur-sm px-4">
        <div class="bg-white dark:bg-[#1e293b] w-full max-w-md p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-2xl">
          <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white">{{ editingUser ? 'Modifier' : 'Ajouter' }} un membre</h2>
          <div class="space-y-4">
            <div><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Nom Complet</label><input v-model="newUserForm.name" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white outline-none h-12 sm:h-10 text-base sm:text-sm"></div>
            <div><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">Email</label><input v-model="newUserForm.email" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white outline-none h-12 sm:h-10 text-base sm:text-sm"></div>
            <div><label class="block text-xs text-slate-500 uppercase font-bold mb-1.5">R√¥le</label>
              <select v-model="newUserForm.role" class="w-full bg-slate-50 dark:bg-[#151515] border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 text-slate-900 dark:text-white outline-none h-12 sm:h-10 text-base sm:text-sm appearance-none">
                <option value="User" class="bg-white dark:bg-[#1e1e1e]">User</option>
                <option value="Admin" class="bg-white dark:bg-[#1e1e1e]">Admin</option>
                <option value="Manager" class="bg-white dark:bg-[#1e1e1e]">Manager</option>
                <option value="Dev" class="bg-white dark:bg-[#1e1e1e]">Dev</option>
                <option value="Tech Lead" class="bg-white dark:bg-[#1e1e1e]">Tech Lead</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-8">
            <button @click="showUserModal = false" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white px-4 py-2 text-sm font-medium">Annuler</button>
            <button @click="saveUser" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-brand-600/10 transition-all active:scale-95">{{ editingUser ? 'Mettre √† jour' : 'Ajouter' }}</button>
          </div>
        </div>
      </div>

      <div v-if="showLegalModal" class="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[200] backdrop-blur-sm px-4"><div class="bg-white dark:bg-[#1e293b] w-full max-w-2xl p-8 rounded-xl border border-slate-200 dark:border-slate-700 relative max-h-[80vh] overflow-y-auto"><button @click="showLegalModal = false" class="absolute top-6 right-6 text-slate-500 hover:text-slate-800 dark:hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button><h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">Mentions L√©gales</h2><div class="text-sm text-slate-600 dark:text-slate-300 space-y-6 leading-relaxed"><section><h3 class="text-slate-900 dark:text-white font-bold mb-2">1. √âditeur</h3><p>Direction Technique Groupe Proxiserve.</p></section><div class="text-xs text-slate-500 mt-8 border-t border-slate-200 dark:border-slate-800 pt-4 flex justify-between items-center"><span>¬© {{ new Date().getFullYear() }} Proxiserve - Prox-Hydro.</span></div></div></div></div>

    </div>

    <!-- MOCKING SYSTEM -->
    <script>
      (function() {
        if (typeof google === 'undefined') {
          console.warn("‚ö†Ô∏è Mode Pr√©visualisation: Mock Activ√© - G√©n√©ration de donn√©es massives");
          
          const USERS = [
             { name: 'Aur√©lien Da Costa', email: 'a.dacosta@proxiserve.fr', avatar: 'https://ui-avatars.com/api/?name=Aur√©lien+Da+Costa&background=0284c7&color=fff', role: 'Admin' },
             { name: 'Sophie Martin', email: 's.martin@proxiserve.fr', avatar: 'https://ui-avatars.com/api/?name=Sophie+Martin&background=e11d48&color=fff', role: 'Manager' },
             { name: 'Thomas Dubreuil', email: 't.dubreuil@proxiserve.fr', avatar: 'https://ui-avatars.com/api/?name=Thomas+Dubreuil&background=059669&color=fff', role: 'Dev' },
             { name: 'Julie Leroy', email: 'j.leroy@prox-hydro.fr', avatar: 'https://ui-avatars.com/api/?name=Julie+Leroy&background=d97706&color=fff', role: 'User' },
             { name: 'Marc Voisin', email: 'm.voisin@proxiserve.fr', avatar: 'https://ui-avatars.com/api/?name=Marc+Voisin&background=7c3aed&color=fff', role: 'Tech Lead' }
          ];

          // ... (Existing Data Generators) ...
          const PROJECT_TEMPLATES = [
            { nom: 'D√©ploiement Fibre Optique Zone Nord', emoji: 'üì°', tags: ['Infra', 'R√©seau'] },
            { nom: 'Migration Serveurs Cloud AWS', emoji: '‚òÅÔ∏è', tags: ['Cloud', 'DevOps', 'Urgent'] },
            { nom: 'App Mobile Techniciens V2', emoji: 'üì±', tags: ['Mobile', 'Terrain'] },
            { nom: 'Refonte Portail Client Extranet', emoji: 'üíª', tags: ['Web', 'UX'] },
            { nom: 'Audit S√©curit√© ISO 27001', emoji: 'üîí', tags: ['S√©curit√©', 'Compliance'] },
            { nom: 'Mise √† jour Flotte Tablettes', emoji: 'üìü', tags: ['Mat√©riel', 'Logistique'] },
            { nom: 'Int√©gration API Partenaire EDF', emoji: 'üîå', tags: ['Backend', 'API'] },
            { nom: 'Optimisation BDD CRM', emoji: 'üóÑÔ∏è', tags: ['Data', 'Performance'] },
            { nom: 'Dashboard KPI Temps R√©el', emoji: 'üìä', tags: ['BI', 'Management'] },
            { nom: 'Formation S√©curit√© √âlectrique', emoji: 'üéì', tags: ['RH', 'Formation'] },
            { nom: 'D√©ploiement Salesforce Agence Sud', emoji: 'ü¶Ñ', tags: ['CRM', 'Salesforce'] },
            { nom: 'Campagne E-mailing Q3', emoji: 'üìß', tags: ['Marketing'] }
          ];

          const TASK_TEMPLATES = [
            'Analyse des besoins', 'R√©daction sp√©cifications', 'Maquettage UI/UX', 'D√©veloppement Backend API',
            'Int√©gration Frontend', 'Tests unitaires', 'Recette utilisateur (UAT)', 'D√©ploiement en pr√©-prod',
            'Correctifs bugs critiques', 'R√©union de lancement', 'Formation des administrateurs', 'Documentation technique',
            'Achat licences', 'Configuration serveurs', 'Validation budget'
          ];

          const STATUSES_PROJ = ['En cours', 'En cours', 'En cours', 'En pause', 'Termin√©', 'Annul√©'];
          const PRIORITIES = ['Haute', 'Moyenne', 'Moyenne', 'Basse'];
          const STATUSES_TASK = ['√Ä faire', 'En cours', 'Termin√©'];

          const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
          const getRandomDate = (start, end) => new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));

          // GENERATE DATA
          const genProjects = [];
          const genTasks = [];

          PROJECT_TEMPLATES.forEach((tpl, index) => {
             const pid = 'p' + index;
             const owner = getRandom(USERS).name;
             const status = getRandom(STATUSES_PROJ);
             
             // Create Project
             genProjects.push({
                id: pid,
                nom: tpl.nom,
                emoji: tpl.emoji,
                tags: tpl.tags,
                description: `Projet strat√©gique pour la **DT Groupe**. \n\nCe projet vise √† am√©liorer l'efficacit√© op√©rationnelle sur le p√©rim√®tre ${tpl.tags[0]}.\n\n*Objectifs :*\n- Optimiser les processus\n- R√©duire les co√ªts de 15%\n- Am√©liorer la satisfaction client`,
                owner: owner,
                status: status,
                priorite: getRandom(PRIORITIES),
                deadline: getRandomDate(new Date(2023, 0, 1), new Date(2025, 11, 31)), 
                created_at: new Date(),
                archived: status === 'Termin√©' && Math.random() > 0.7, 
                rank: index + 1,
                meeting_notes: Math.random() > 0.7 ? "Point bloquant sur le budget √† revoir." : ""
             });

             // Create 8 to 12 tasks per project
             const numTasks = Math.floor(Math.random() * 5) + 8; 
             for(let i=0; i<numTasks; i++) {
                const tStatus = getRandom(STATUSES_TASK);
                const isLate = Math.random() > 0.8; // 20% chance of being late if not done
                let tDate = new Date();
                
                if(tStatus === 'Termin√©') {
                   tDate = getRandomDate(new Date(2023, 0, 1), new Date()); // Past date
                } else if (isLate) {
                   tDate = getRandomDate(new Date(2023, 0, 1), new Date()); // Past date but not done
                } else {
                   tDate = getRandomDate(new Date(), new Date(2025, 11, 31)); // Future date
                }

                genTasks.push({
                   id: pid + '_t' + i,
                   project_id: pid,
                   titre: getRandom(TASK_TEMPLATES) + (Math.random() > 0.5 ? ' - Phase ' + (i+1) : ''),
                   status: tStatus,
                   assignee: getRandom(USERS).name,
                   due_date: tDate
                });
             }
          });

          const MOCK_DATA = {
            currentUser: USERS[0],
            team: USERS,
            projects: genProjects,
            tasks: genTasks
          };

          const mockServer = {
            getAllData: () => JSON.parse(JSON.stringify(MOCK_DATA)),
            createTask: (d) => ({...d, id: 'mock-t-'+Date.now(), status: d.status || '√Ä faire'}),
            createProject: (d) => ({...d, id: 'mock-p-'+Date.now(), status: 'En cours', progress: 0, rank: 999, tags: []}),
            updateProject: (p) => p,
            updateTaskStatus: () => true,
            updateTaskDetails: (t) => t, 
            deleteTask: (id) => true,
            updateProjectOrder: (order) => true,
            // USER CRUD MOCKS
            saveUser: (u) => ({...u, avatar: `https://ui-avatars.com/api/?name=${u.name}&background=random&color=fff&size=24`}),
            deleteUser: (index) => true
          };
          
          const createMockRunner = (handlers = {}) => {
            const runner = {
              withSuccessHandler: (fn) => createMockRunner({ ...handlers, success: fn }),
              withFailureHandler: (fn) => createMockRunner({ ...handlers, failure: fn }),
            };
            Object.keys(mockServer).forEach(method => {
              runner[method] = (...args) => {
                setTimeout(() => {
                   const result = mockServer[method](...args);
                   if (handlers.success) handlers.success(result);
                   if(method === 'createTask') MOCK_DATA.tasks.push(result);
                   if(method === 'createProject') MOCK_DATA.projects.push(result);
                }, 400); // Simulate network latency
              };
            });
            return runner;
          };
          window.google = { script: { run: createMockRunner() } };
        }
      })();
    </script>

    <script>
      const { createApp, ref, computed, onMounted, onUpdated, nextTick, watch } = Vue;

      const toInputDate = (d) => {
         if (!d) return new Date().toISOString().split('T')[0];
         return new Date(d).toISOString().split('T')[0];
      };

      createApp({
        setup() {
          const loading = ref(true);
          const projects = ref([]);
          const tasks = ref([]);
          const teamMembers = ref([]);
          const currentUser = ref({});
          const toasts = ref([]); 
          const showCompleted = ref(false); // Default false for standard view
          
          const sidebarOpen = ref(false); // Default closed on mobile
          const isMobile = ref(window.innerWidth < 1024);
          
          const currentViewScope = ref('dashboard'); 
          const viewType = ref('grid'); 
          const searchQuery = ref("");
          const selectedUserFilter = ref(null);
          
          const scrollContainer = ref(null); 

          const activeProject = ref(null);
          const isEditingDesc = ref(false); 
          const newTaskTitle = ref("");
          const newTaskAssignee = ref("");
          const newTaskDate = ref(toInputDate(new Date())); 
          const taskInputRef = ref(null); 
          
          const editingTaskId = ref(null);
          const editTaskForm = ref({});
          const showNewProjectModal = ref(false);
          const showLegalModal = ref(false);
          
          // User CRUD States
          const showTeamModal = ref(false); // Used only on mobile sidebar navigation to open the view
          const showKPIModal = ref(false); // Used only on mobile sidebar navigation to open the view
          
          const showUserModal = ref(false);
          const editingUser = ref(null);
          const newUserForm = ref({ name: '', email: '', role: 'User' });
          
          const newProjectForm = ref({ nom: '', emoji: 'üìÅ', owner: '', priorite: 'Moyenne', description: '', deadline_str: toInputDate(new Date()) }); 

          // Window Resize Listener for Responsive Logic
          window.addEventListener('resize', () => {
             isMobile.value = window.innerWidth < 1024;
             if(!isMobile.value) sidebarOpen.value = false; // Reset when going to desktop
          });

          // FORCE ICON REFRESH ON VIEW CHANGE
          watch([viewType, currentViewScope], () => {
             nextTick(() => {
                if (window.lucide) window.lucide.createIcons();
             });
          });

          // WATCH MODALS TO REFRESH ICONS
          watch([showLegalModal, showNewProjectModal, activeProject, showUserModal], () => {
             nextTick(() => {
                if (window.lucide) window.lucide.createIcons();
             });
          });

          const enrichedProjects = computed(() => {
            const sortedProjects = [...projects.value].sort((a, b) => (a.rank || 0) - (b.rank || 0));
            return sortedProjects.map(p => {
              const pTasks = tasks.value.filter(t => t.project_id === p.id);
              const total = pTasks.length;
              const done = pTasks.filter(t => t.status === 'Termin√©').length;
              const progress = total === 0 ? 0 : Math.round((done / total) * 100);
              return { ...p, progress, tasksTotal: total };
            });
          });

          const filteredProjects = computed(() => {
             let base = enrichedProjects.value;
             
             if (currentViewScope.value === 'active') {
                base = base.filter(p => !p.archived);
                if (!showCompleted.value) {
                   base = base.filter(p => p.status !== 'Termin√©' && p.status !== 'Annul√©');
                }
             } else {
                base = base.filter(p => p.archived || p.status === 'Termin√©' || p.status === 'Annul√©');
             }

             if (searchQuery.value) {
                const q = searchQuery.value.toLowerCase();
                base = base.filter(p => p.nom.toLowerCase().includes(q) || p.owner.toLowerCase().includes(q));
             }
             if (selectedUserFilter.value) base = base.filter(p => p.owner === selectedUserFilter.value);
             return base;
          });
          
          // User Filter for Team View
          const filteredTeam = computed(() => {
             if (!searchQuery.value) return teamMembers.value;
             const q = searchQuery.value.toLowerCase();
             return teamMembers.value.filter(u => u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
          });

          const kpiData = computed(() => {
             const activeProjs = enrichedProjects.value.filter(p => !p.archived && p.status !== 'Termin√©' && p.status !== 'Annul√©');
             const allTasks = tasks.value;
             const activeProjects = activeProjs.length;
             const tasksPending = allTasks.filter(t => t.status !== 'Termin√©').length;
             const tasksDone = allTasks.filter(t => t.status === 'Termin√©').length;
             const totalProgress = activeProjs.reduce((acc, p) => acc + p.progress, 0);
             const globalProgress = activeProjects ? Math.round(totalProgress / activeProjects) : 0;
             const userStats = teamMembers.value.map(user => {
               const count = allTasks.filter(t => t.assignee === user.name && t.status !== 'Termin√©').length;
               return { name: user.name, count };
             }).sort((a,b) => b.count - a.count);
             const maxTasks = Math.max(...userStats.map(u => u.count)) || 1;
             return { activeProjects, tasksPending, tasksDone, globalProgress, userStats, maxTasks, topProjects: activeProjs.sort((a,b) => b.progress - a.progress).slice(0, 5) };
          });
          
          const dashboardData = computed(() => {
             const now = new Date();
             now.setHours(0,0,0,0);
             
             const topProjects = enrichedProjects.value
                .filter(p => !p.archived && p.status !== 'Termin√©' && p.status !== 'Annul√©')
                .sort((a, b) => {
                   const prioScore = { 'Haute': 3, 'Moyenne': 2, 'Basse': 1 };
                   if (prioScore[b.priorite] !== prioScore[a.priorite]) return prioScore[b.priorite] - prioScore[a.priorite];
                   return (a.rank || 0) - (b.rank || 0);
                })
                .slice(0, 3);

             const allOverdue = tasks.value.filter(t => {
                if(t.status === 'Termin√©' || !t.due_date) return false;
                const due = new Date(t.due_date);
                return due < now;
             }).sort((a,b) => new Date(a.due_date) - new Date(b.due_date));

             const myTasks = tasks.value.filter(t => {
                if(t.status === 'Termin√©' || !t.due_date) return false;
                if(t.assignee !== currentUser.value.name) return false;
                const due = new Date(t.due_date);
                return due >= now; 
             }).sort((a,b) => new Date(a.due_date) - new Date(b.due_date)).slice(0, 5);
             
             return { topProjects, allOverdue, myTasks };
          });

          const getTasksByProject = (pid) => tasks.value.filter(t => t.project_id === pid);
          const getTasksByStatus = (status) => activeProject.value ? tasks.value.filter(t => t.project_id === activeProject.value.id && t.status === status) : [];

          const loadData = () => {
            loading.value = true;
            google.script.run.withSuccessHandler((data) => {
                projects.value = data.projects;
                tasks.value = data.tasks;
                if(data.team) teamMembers.value = data.team;
                if(data.currentUser) {
                   currentUser.value = data.currentUser;
                   newTaskAssignee.value = data.currentUser.name;
                   newProjectForm.value.owner = data.currentUser.name;
                }
                loading.value = false;
                initIcons();
              }).getAllData();
          };

          const showToast = (message, type = 'info') => {
             const id = Date.now();
             const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'alert-circle' : 'info');
             toasts.value.push({ id, message, type, icon });
             setTimeout(() => { toasts.value = toasts.value.filter(t => t.id !== id); }, 3000);
             nextTick(() => initIcons());
          };

          const renderMarkdown = (text) => text ? marked.parse(text) : '';
          const stripMarkdown = (text) => text ? text.replace(/[*#_]/g, '') : '';

          // ... (Sortable Logic remains same) ...
          const initSortable = (el, status) => {
             if (el._sortable) return;
             const isMobileDrag = window.innerWidth < 1024;
             el._sortable = new Sortable(el, {
               group: 'tasks', animation: 150, ghostClass: 'ghost-card', handle: '.drag-handle', disabled: isMobileDrag, delay: 200, delayOnTouchOnly: true,
               onEnd: (evt) => {
                  const itemEl = evt.item;
                  const newStatus = evt.to.getAttribute('data-status');
                  const taskId = itemEl.getAttribute('data-id');
                  if (!newStatus || !taskId) return;
                  const task = tasks.value.find(t => t.id == taskId);
                  if (task && task.status !== newStatus) {
                     const oldStatus = task.status;
                     task.status = newStatus;
                     google.script.run.withSuccessHandler(() => showToast('Statut mis √† jour', 'success')).withFailureHandler(() => { task.status = oldStatus; showToast('Erreur', 'error'); }).updateTaskStatus(task.id, newStatus);
                  }
               }
             });
          };

          const initProjectSortable = (el) => {
             if (el._sortable) return;
             el._sortable = new Sortable(el, {
               animation: 150, ghostClass: 'ghost-card', handle: '.project-drag-handle',
               onEnd: (evt) => {
                  const itemEl = evt.item;
                  const newIndex = evt.newIndex;
                  const oldIndex = evt.oldIndex;
                  if (newIndex === oldIndex) return;
                  const visibleProjects = filteredProjects.value;
                  const movedItem = visibleProjects[oldIndex];
                  visibleProjects.splice(oldIndex, 1);
                  visibleProjects.splice(newIndex, 0, movedItem);
                  visibleProjects.forEach((p, idx) => {
                     const mainProj = projects.value.find(mp => mp.id === p.id);
                     if(mainProj) mainProj.rank = idx + 1;
                  });
                  projects.value = [...projects.value]; 
                  const orderMap = visibleProjects.map((p, idx) => ({ id: p.id, rank: idx + 1 }));
                  google.script.run.withSuccessHandler(() => showToast('Priorit√©s mises √† jour', 'success')).withFailureHandler(() => showToast('Erreur', 'error')).updateProjectOrder(orderMap);
               }
             });
          };

          const updateProject = (project) => {
             google.script.run.withSuccessHandler(() => showToast('Projet mis √† jour', 'success')).withFailureHandler(() => showToast('Erreur sauvegarde', 'error')).updateProject(project);
          };

          const isOverdueProject = (project) => {
             if (!project.deadline || project.status === 'Termin√©') return false;
             return new Date(project.deadline) < new Date();
          };
          const hasDateConflict = (project) => {
             if (!project.deadline) return false;
             const projDead = new Date(project.deadline);
             const pTasks = getTasksByProject(project.id);
             return pTasks.some(t => t.due_date && new Date(t.due_date) > projDead);
          };

          const openProjectDetails = (project) => { activeProject.value = project; initIcons(); };
          const toggleEditDesc = () => { isEditingDesc.value = !isEditingDesc.value; };
          const addTag = (project, event) => {
             const val = event.target.value.trim();
             if (val && (!project.tags || !project.tags.includes(val))) {
                if(!project.tags) project.tags = [];
                project.tags.push(val);
                updateProject(project);
                event.target.value = '';
             }
          };
          const removeTag = (project, index) => {
             project.tags.splice(index, 1);
             updateProject(project);
          };
          const exportToCSV = () => {
             const headers = ["Projet", "Propri√©taire", "Deadline", "Priorit√©", "Statut", "Avancement", "Notes"];
             const rows = filteredProjects.value.map(p => [
                p.nom, p.owner, formatDateShort(p.deadline), p.priorite, p.status, p.progress + '%', p.meeting_notes || ''
             ]);
             let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", "revue_projets_dt.csv");
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             showToast('Export CSV g√©n√©r√©', 'success');
          };

          const addTask = () => {
            if (!newTaskTitle.value.trim() || !activeProject.value) return;
            const tempId = 'temp_' + Date.now();
            const taskPayload = {
              project_id: activeProject.value.id, titre: newTaskTitle.value, assignee: newTaskAssignee.value || currentUser.value.name,
              due_date: new Date(newTaskDate.value), status: '√Ä faire'
            };
            tasks.value.push({ ...taskPayload, id: tempId });
            newTaskTitle.value = "";
            google.script.run.withSuccessHandler((serverTask) => {
                const idx = tasks.value.findIndex(t => t.id === tempId);
                if (idx !== -1) tasks.value[idx] = serverTask;
                showToast('T√¢che ajout√©e', 'success');
                initIcons();
              }).createTask(taskPayload);
            nextTick(() => { if(taskInputRef.value) taskInputRef.value.focus(); });
          };

          const cycleStatus = (task) => {
            const map = { '√Ä faire': 'En cours', 'En cours': 'Termin√©', 'Termin√©': '√Ä faire' };
            const oldStatus = task.status;
            task.status = map[oldStatus];
            google.script.run.withSuccessHandler(() => showToast('Statut mis √† jour', 'success')).withFailureHandler(() => { task.status = oldStatus; showToast('Erreur', 'error'); }).updateTaskStatus(task.id, task.status);
          };

          const startEdit = (task) => {
            editingTaskId.value = task.id;
            editTaskForm.value = { ...task, due_date_str: toInputDate(task.due_date) };
            nextTick(() => { const inputs = document.querySelectorAll('input'); });
            initIcons();
          };
          const cancelEdit = () => { editingTaskId.value = null; editTaskForm.value = {}; };
          const saveEdit = () => {
             if (!editingTaskId.value) return;
             const idx = tasks.value.findIndex(t => t.id === editingTaskId.value);
             if (idx !== -1) {
                tasks.value[idx].titre = editTaskForm.value.titre;
                tasks.value[idx].assignee = editTaskForm.value.assignee;
                tasks.value[idx].due_date = new Date(editTaskForm.value.due_date_str);
             }
             google.script.run.withSuccessHandler(() => showToast('T√¢che modifi√©e', 'success')).updateTaskDetails(editTaskForm.value);
             cancelEdit();
          };
          const deleteTask = (task) => {
             if(!confirm('Supprimer cette t√¢che ?')) return;
             tasks.value = tasks.value.filter(t => t.id !== task.id);
             google.script.run.withSuccessHandler(() => showToast('T√¢che supprim√©e', 'info')).deleteTask(task.id);
          };

          const createProject = () => {
             if(!newProjectForm.value.nom) { showToast('Le nom du projet est requis', 'error'); return; }
             showNewProjectModal.value = false;
             loading.value = true;
             const minRank = Math.min(...projects.value.map(p => p.rank || 0), 0);
             newProjectForm.value.rank = minRank - 1;
             if(newProjectForm.value.deadline_str) newProjectForm.value.deadline = new Date(newProjectForm.value.deadline_str);
             google.script.run.withSuccessHandler((newP) => {
                projects.value.push(newP);
                loading.value = false;
                newProjectForm.value = { nom: '', emoji: 'üìÅ', owner: currentUser.value.name || '', priorite: 'Moyenne', description: '', deadline_str: toInputDate(new Date()) };
                showToast('Projet cr√©√© avec succ√®s', 'success');
                if(scrollContainer.value) scrollContainer.value.scrollTop = 0;
                initIcons();
             }).createProject(newProjectForm.value);
          };
          
          // User CRUD Methods
          const openUserModal = (user = null) => {
            editingUser.value = user;
            if(user) {
              newUserForm.value = { ...user };
            } else {
              newUserForm.value = { name: '', email: '', role: 'User' };
            }
            showUserModal.value = true;
          };
          
          const saveUser = () => {
            if(!newUserForm.value.name || !newUserForm.value.email) {
              showToast('Nom et email requis', 'error');
              return;
            }
            
            showUserModal.value = false;
            
            if(editingUser.value) {
              // Update
              const idx = teamMembers.value.findIndex(u => u.email === editingUser.value.email);
              if(idx !== -1) {
                // In a real app, update via backend. Here we update mock state locally first for responsiveness
                // Assuming saveUser returns updated user
                google.script.run.withSuccessHandler((updatedUser) => {
                  teamMembers.value[idx] = updatedUser;
                  showToast('Membre mis √† jour', 'success');
                }).saveUser(newUserForm.value);
              }
            } else {
              // Create
              google.script.run.withSuccessHandler((newUser) => {
                teamMembers.value.push(newUser);
                showToast('Membre ajout√©', 'success');
              }).saveUser(newUserForm.value);
            }
          };
          
          const deleteUser = (index) => {
            if(!confirm('Supprimer ce membre ?')) return;
            const user = teamMembers.value[index];
            google.script.run.withSuccessHandler(() => {
              teamMembers.value.splice(index, 1);
              showToast('Membre supprim√©', 'info');
            }).deleteUser(index); // Passing index for mock simplicity, usually ID
          };

          const getPriorityClass = (p) => {
            switch(p) {
              case 'Haute': return 'text-red-600 bg-red-100 border-red-200 dark:text-red-400 dark:border-red-900/50 dark:bg-red-900/20';
              case 'Moyenne': return 'text-yellow-600 bg-yellow-100 border-yellow-200 dark:text-yellow-400 dark:border-yellow-900/50 dark:bg-yellow-900/20';
              default: return 'text-blue-600 bg-blue-100 border-blue-200 dark:text-blue-400 dark:border-blue-900/50 dark:bg-blue-900/20';
            }
          };
          const getProjectStatusClass = (s) => {
             switch(s) {
                case 'Termin√©': return 'text-green-700 bg-green-100 border-green-200 dark:text-green-400 dark:border-green-900/50 dark:bg-green-900/20';
                case 'En cours': return 'text-yellow-700 bg-yellow-100 border-yellow-200 dark:text-yellow-400 dark:border-yellow-900/50 dark:bg-yellow-900/20';
                case 'En pause': return 'text-slate-600 bg-slate-100 border-slate-200 dark:text-slate-400 dark:border-slate-700 dark:bg-slate-800';
                case 'Annul√©': return 'text-red-700 bg-red-100 border-red-200 dark:text-red-400 dark:border-red-900/50 dark:bg-red-900/20';
                default: return 'text-slate-600 bg-slate-100 border-slate-200';
             }
          };
          const getStatusColor = (s) => {
             if (s === '√Ä faire') return 'bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-200';
             if (s === 'En cours') return 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
             return 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
          };
          const getUserAvatar = (name) => {
             const user = teamMembers.value.find(u => u.name === name);
             if(user) return user.avatar;
             return `https://ui-avatars.com/api/?name=${name || '?'}&background=random&color=fff&size=24`;
          };
          const formatDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
          const formatDateShort = (d) => d ? new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '';
          const isOverdue = (task) => {
             if(!task.due_date || task.status === 'Termin√©') return false;
             const now = new Date(); now.setHours(0,0,0,0);
             return new Date(task.due_date) < now;
          };

          const initIcons = () => nextTick(() => { if (window.lucide) window.lucide.createIcons(); });

          onMounted(() => loadData());
          onUpdated(() => initIcons());

          return {
            loading, sidebarOpen, isMobile, currentViewScope, viewType, searchQuery, selectedUserFilter, toasts, showCompleted,
            activeProject, isEditingDesc, newTaskTitle, newTaskAssignee, newTaskDate, taskInputRef, scrollContainer,
            showNewProjectModal, showLegalModal, showTeamModal, showKPIModal, showUserModal,
            newProjectForm, newUserForm, filteredProjects, filteredTeam, getTasksByProject, getTasksByStatus, teamMembers, currentUser, kpiData, 
            dashboardData, projects, tasks, editingUser,
            openProjectDetails, toggleEditDesc, addTask, cycleStatus, createProject, updateProject, isOverdueProject,
            editingTaskId, editTaskForm, startEdit, cancelEdit, saveEdit, deleteTask,
            getPriorityClass, getProjectStatusClass, getStatusColor, getUserAvatar, formatDate, formatDateShort, isOverdue,
            initSortable, initProjectSortable, renderMarkdown, stripMarkdown, toInputDate,
            addTag, removeTag, hasDateConflict, exportToCSV,
            openUserModal, saveUser, deleteUser
          };
        }
      }).mount('#app');
    </script>
  </body>
</html>
